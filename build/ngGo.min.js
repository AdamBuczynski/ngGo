/**
 * ngGo - v3.0.2 - 2014-12-03
 * https://github.com/AdamBuczynski/ngGo
 *
 * Copyright (c) 2014 Adam Buczynski
 */
!function(a,b,c){"use strict";b.module("ngGo.Board.Directive",["ngGo.Board.Service","ngGo.Board.Layer.Directive","ngGo.Board.Layer.GridLayer.Directive","ngGo.Board.Layer.StonesLayer.Directive","ngGo.Board.Layer.MarkupLayer.Directive","ngGo.Board.Layer.ShadowLayer.Directive","ngGo.Board.Layer.ScoreLayer.Directive","ngGo.Board.Layer.HoverLayer.Directive"]).directive("board",["Board",function(b){return{restrict:"E",template:"\n<gridlayer></gridlayer>\n<shadowlayer></shadowlayer>\n<stoneslayer></stoneslayer>\n<scorelayer></scorelayer>\n<markuplayer></markuplayer>\n<hoverlayer></hoverlayer>",controller:["$scope",function(a){a.Board=new b}],link:function(b,c,d){var e=a.pixelRatio||1;d.$observe("size",function(a){a=a.split("x"),b.Board.setSize(a[0],a[1])}),b.$on("ngGo.board.resize",function(a,c,d){b.Board.setDrawSize(c*e,d*e)}),d.$observe("coordinates",function(a){b.Board.toggleCoordinates(parseBool(a))})}}}]),b.module("ngGo.Board.Service",["ngGo","ngGo.Board.Directive","ngGo.Board.Theme.Service","ngGo.Board.Object.Markup.Service","ngGo.Board.Object.Stone.Service","ngGo.Board.Object.StoneMini.Service","ngGo.Board.Object.StoneFaded.Service"]).provider("Board",function(){var a={defaultSize:0,coordinates:!1,section:{top:0,right:0,bottom:0,left:0},margin:.04};this.setConfig=function(c){a=b.extend(a,c)},this.$get=["BoardTheme","StoneColor","Stone","Markup",function(c,d){var e=function(){var a=Math.min(this.drawWidth,this.drawHeight),b=a*(1-this.margin),c=Math.max(this.width,this.height);this.cellSize=Math.round(b/c),this.drawMargin=Math.round((a-b)/2+this.cellSize/2)},f=function(){this.grid={xLeft:0+this.section.left,xRight:this.width-1-this.section.right,yTop:0+this.section.top,yBot:this.height-1-this.section.bottom}},g=function(d){this.config=b.extend({},a,d||{}),this.theme=new c(this.config.theme),this.drawWidth=0,this.drawHeight=0,this.colorMultiplier=1,this.layers={},this.width=this.height=parseInt(this.config.defaultSize),this.section=b.extend({},a.section,this.config.section),this.margin=this.config.margin,f.call(this)};return g.prototype.setMargin=function(a){this.margin!=a&&(this.margin=a,this.resized())},g.prototype.resetMargin=function(){this.setMargin(this.config.margin)},g.prototype.setSection=function(c){c&&(c=b.extend({},a.section,c),(this.section.top!=c.top||this.section.bottom!=c.bottom||this.section.left!=c.left||this.section.right!=c.right)&&(this.section=c,this.resized()))},g.prototype.setSize=function(b,c){if(b=parseInt(b||c||a.defaultSize),c=parseInt(c||b||a.defaultSize),b!=this.width||c!=this.height){this.width=b,this.height=c;for(var d in this.layers)this.layers[d].setSize(b,c);this.resized()}},g.prototype.setDrawSize=function(a,b){this.drawWidth=a,this.drawHeight=b,this.resized()},g.prototype.resized=function(){f.call(this),e.call(this),this.redraw()},g.prototype.add=function(a,b,c,d){"undefined"!=typeof this.layers[a]&&this.layers[a].add(b,c,d)},g.prototype.remove=function(a,b,c){"undefined"!=typeof this.layers[a]&&this.layers[a].remove(b,c)},g.prototype.get=function(a,b,c){return this.layers[a]&&this.layers[a].get(b,c)},g.prototype.has=function(a,b,c){return this.layers[a]&&this.layers[a].has(b,c)},g.prototype.setAll=function(a,b){"undefined"!=typeof this.layers[a]&&this.layers[a].setAll(b)},g.prototype.removeAll=function(a){if(a)"undefined"!=typeof this.layers[a]&&this.layers[a].removeAll();else for(a in this.layers)this.layers[a].removeAll()},g.prototype.toggleCoordinates=function(a){this.config.coordinates="undefined"!=typeof a?a:!this.config.coordinates,this.layers.grid&&this.layers.grid.showCoordinates(this.config.coordinates)},g.prototype.getState=function(a){if(a)return this.layers[a]?this.layers[a].getAll():null;var b={};for(a in this.layers){var c=this.layers[a].getAll();c&&!c.isEmpty()&&(b[a]=c)}return b},g.prototype.restoreState=function(a,b){if(b)return void(this.layers[b]&&this.layers[b].setAll(a));for(b in this.layers)this.layers[b].removeAll(),a[b]&&this.layers[b].setAll(a[b])},g.prototype.redraw=function(){for(var a in this.layers)this.layers[a].redraw()},g.prototype.swapColors=function(){this.colorMultiplier=-this.colorMultiplier,this.layers.stones&&(this.layers.shadow&&this.layers.shadow.clear(),this.layers.stones.redraw())},g.prototype.getStoneColor=function(a,b){return this.layers.stones?this.layers.stones.get(a,b):d.NONE},g.prototype.getCellSize=function(){return this.cellSize},g.prototype.getAbsX=function(a){return this.drawMargin+Math.round(a*this.cellSize)},g.prototype.getAbsY=function(a){return this.drawMargin+Math.round(a*this.cellSize)},g.prototype.getGridX=function(a){return Math.round((a-this.drawMargin)/this.cellSize)},g.prototype.getGridY=function(a){return Math.round((a-this.drawMargin)/this.cellSize)},g.prototype.isOnBoard=function(a,b){return a>=0&&b>=0&&a<this.width&&b<this.height},g}]}),b.module("ngGo.Board.DefaultClearHandler.Service",["ngGo"]).factory("DefaultClearHandler",function(){return function(a,b){var c=this.board.getAbsX(b.x),d=this.board.getAbsY(b.y),e=this.board.getCellSize(),f=this.board.theme.get("stoneRadius",e);a.clearRect(c-f,d-f,2*f,2*f)}}),b.module("ngGo.Board.Grid.Service",["ngGo","ngGo.Board.GridChanges.Service"]).factory("BoardGrid",["BoardGridChanges",function(a){var c=function(a,c,d){var e={x:a,y:c};return"object"==typeof this.grid[a][c]?b.extend(e,this.grid[a][c]):(e[d]=this.grid[a][c],e)},d=function(a,b,c){this.width=0,this.height=0,this.grid=[],this.emptyValue=null,"undefined"!=typeof c&&(this.emptyValue=c),(a||b)&&this.setSize(a,b)};return d.prototype.set=function(a,b,c){this.isOnGrid(a,b)&&(this.grid[a][b]=c)},d.prototype.unset=function(a,b){this.isOnGrid(a,b)&&(this.grid[a][b]=this.emptyValue)},d.prototype.has=function(a,b){return this.isOnGrid(a,b)&&this.grid[a][b]!==this.emptyValue},d.prototype.is=function(a,b,c){return this.isOnGrid(a,b)&&this.grid[a][b]===c},d.prototype.get=function(a,b,d){return this.isOnGrid(a,b)&&this.grid[a][b]!==this.emptyValue?d?c.call(this,a,b,d):this.grid[a][b]:this.emptyValue},d.prototype.all=function(a){if(!a)return this.grid;for(var b=[],d=0;d<this.width;d++)for(var e=0;e<this.height;e++)this.grid[d][e]!==this.emptyValue&&b.push(c.call(this,d,e,a));return b},d.prototype.isEmpty=function(){for(var a=0;a<this.width;a++)for(var b=0;b<this.height;b++)if(this.grid[a][b]!==this.emptyValue)return!1;return!0},d.prototype.populate=function(a){for(var b=0;b<this.width;b++)for(var c=0;c<this.height;c++)this.grid[b][c]=a},d.prototype.clear=function(){for(var a=0;a<this.width;a++)for(var b=0;b<this.height;b++)this.grid[a][b]=this.emptyValue},d.prototype.clone=function(){var a=new d;return a.grid=b.copy(this.grid),a.emptyValue=this.emptyValue,a.width=this.width,a.height=this.height,a},d.prototype.isSameAs=function(a){if(this.width!=a.width||this.height!=a.height)return!1;for(var b=0;b<this.width;b++)for(var c=0;c<this.height;c++)if(this.grid[b][c]!=a[b][c])return!1;return!0},d.prototype.compare=function(b,d){var e=new a;if(this.width!=b.width||this.height!=b.height)return console.warn("Trying to compare grids of a different size"),e;for(var f=0;f<this.width;f++)for(var g=0;g<this.height;g++)b.grid[f][g]!==this.emptyValue&&b.grid[f][g]!==this.grid[f][g]&&e.add.push(c.call(b,f,g,d)),this.grid[f][g]!==this.emptyValue&&b.grid[f][g]!==this.grid[f][g]&&e.remove.push(c.call(this,f,g,d));return e},d.prototype.isOnGrid=function(a,b){return a>=0&&b>=0&&a<this.width&&b<this.height},d.prototype.whenEmpty=function(a){this.emptyValue=a},d.prototype.setSize=function(a,b){a=a||b||0,b=b||a||0,this.width=parseInt(a),this.height=parseInt(b),this.grid=[];for(var c=0;c<this.width;c++){this.grid[c]=[];for(var d=0;d<this.height;d++)this.grid[c][d]=this.emptyValue}},d.prototype.getSize=function(){return{width:this.width,height:this.height}},d}]),b.module("ngGo.Board.GridChanges.Service",["ngGo"]).factory("BoardGridChanges",function(){var a=function(a,b){var c,d=[];for(var e in a){c=!0;for(var f in b)if(a[e].x==b[f].x&&a[e].y==b[f].y){c=!1;break}c&&d.push(a[e])}return d};return function(){this.add=[],this.remove=[],this.concat=function(b){this.add=a(this.add,b.remove).concat(b.add),this.remove=a(this.remove,b.add).concat(b.remove)},this.has=function(){return!(!this.add.length&&!this.remove.length)}}}),b.module("ngGo.Board.Layer.Directive",["ngGo.Board.Layer.Service","ngGo.Board.Layer.GridLayer.Service","ngGo.Board.Layer.ShadowLayer.Service"]).directive("boardlayer",["$injector",function(b){return{restrict:"E",template:"<canvas></canvas>",link:function(c,d,e){var f=e.class||"",g=e.layerType||"board",h=a.pixelRatio||1,i=d.find("canvas"),j=i[0].getContext("2d");if(h>1&&j.scale(h,h),c.$on("ngGo.board.resize",function(a,b,c){i.attr("width",b*h),i.attr("height",c*h),i.css({width:b,height:c})}),g=g.charAt(0).toUpperCase()+g.substr(1)+"Layer",b.has(g)){var k=b.get(g);c.Board.layers[f]=new k(c.Board,j)}}}}]),b.module("ngGo.Board.Layer.Service",["ngGo","ngGo.Board.Grid.Service"]).factory("BoardLayer",["BoardGrid",function(a){var b=function(b,c){this.board=b,this.context=c,this.grid=new a};return b.prototype.setSize=function(a,b){this.grid.setSize(a,b)},b.prototype.getAll=function(){return this.grid.clone()},b.prototype.setAll=function(a){this.grid=a.clone()},b.prototype.removeAll=function(){this.clear(),this.grid.clear()},b.prototype.add=function(a,b,c){this.clearCell(a,b),this.grid.set(a,b,c),this.drawCell(a,b)},b.prototype.remove=function(a,b){this.clearCell(a,b),this.grid.unset(a,b)},b.prototype.get=function(a,b){return this.grid.get(a,b)},b.prototype.has=function(a,b){return this.grid.has(a,b)},b.prototype.draw=function(){},b.prototype.clear=function(){this.context.clearRect(0,0,this.context.canvas.clientWidth,this.context.canvas.clientHeight)},b.prototype.redraw=function(){this.clear(),this.draw()},b.prototype.drawCell=function(){},b.prototype.clearCell=function(){},b.prototype.redrawCell=function(a,b){this.clearCell(a,b),this.drawCell(a,b)},b.prototype.getContext=function(){return this.context},b}]),b.module("ngGo.Board.Layer.GridLayer.Directive",["ngGo.Board.Layer.GridLayer.Service"]).directive("gridlayer",["GridLayer",function(b){return{restrict:"E",template:"<canvas></canvas>",link:function(c,d,e){if(!c.Board)return void console.warn("No board present in scope for grid layer");var f=a.pixelRatio||1,g=e.name||"grid",h=d.find("canvas"),i=h[0].getContext("2d");f>1&&i.scale(f,f),c.$on("ngGo.board.resize",function(a,b,c){h.attr("width",b*f),h.attr("height",c*f),h.css({width:b,height:c})}),c.Board.layers[g]=new b(c.Board,i)}}}]),b.module("ngGo.Board.Layer.GridLayer.Service",["ngGo","ngGo.Board.Layer.Service","ngGo.Board.Object.Coordinates.Service"]).factory("GridLayer",["BoardLayer","Coordinates",function(a,c){var d=function(a,b,c,d){if(!(a<this.board.grid.xLeft||a>this.board.grid.xRight||b<this.board.grid.yTop||b>this.board.grid.yBot)){var e=this.board.getAbsX(a),f=this.board.getAbsY(b);this.context.beginPath(),this.context.fillStyle=d,this.context.arc(e,f,c,0,2*Math.PI,!0),this.context.fill()}},e=function(b,c){this.coordinates=!1,this.coordinatesMargin=b.theme.get("coordinatesMargin"),a.call(this,b,c)};return b.extend(e.prototype,a.prototype),e.prototype.showCoordinates=function(a){a!==this.coordinates&&(this.coordinates=a,this.coordinates?this.board.setMargin(this.coordinatesMargin):this.board.resetMargin())},e.prototype.getAll=function(){return null},e.prototype.setAll=function(){},e.prototype.removeAll=function(){},e.prototype.draw=function(){var a=Math.round(this.board.drawMargin),b=Math.round(this.board.drawMargin),e=this.board.grid.yBot-this.board.grid.yTop,f=this.board.grid.xRight-this.board.grid.xLeft;this.board.section.top&&(e+=.5,b+=Math.round((this.board.grid.yBot-e)*this.board.cellSize)),this.board.section.bottom&&(e+=.5),this.board.section.left&&(f+=.5,a+=Math.round((this.board.grid.xRight-f)*this.board.cellSize)),this.board.section.right&&(f+=.5);var g=Math.round(this.board.cellSize*f),h=Math.round(this.board.cellSize*e),i=this.board.getCellSize(),j=this.board.theme.get("gridLineWidth",i),k=this.board.theme.get("gridLineColor"),l=this.board.theme.get("starRadius",i),m=this.board.theme.get("starColor"),n=this.board.theme.get("canvasTranslate",i,j),o=this.board.theme.get("starPoints",this.board.width,this.board.height);this.context.translate(n,n),this.context.beginPath(),this.context.lineWidth=j,this.context.strokeStyle=k;var p,q,r;for(p=this.board.grid.xLeft;p<=this.board.grid.xRight;p++)q=this.board.getAbsX(p),this.context.moveTo(q,b),this.context.lineTo(q,b+h);for(p=this.board.grid.yTop;p<=this.board.grid.yBot;p++)r=this.board.getAbsY(p),this.context.moveTo(a,r),this.context.lineTo(a+g,r);this.context.stroke();for(p in o)d.call(this,o[p].x,o[p].y,l,m);this.context.translate(-n,-n),this.coordinates&&c.draw.call(this)},e.prototype.clearCell=function(a,b){var c=this.board.getAbsX(a),d=this.board.getAbsY(b),e=this.board.getCellSize(),f=this.board.theme.get("stoneRadius",e),g=this.board.theme.get("gridLineWidth",e),h=this.board.theme.get("canvasTranslate",e,g);this.context.translate(h,h),this.context.clearRect(c-f,d-f,2*f,2*f),this.context.translate(-h,-h)},e.prototype.redrawCell=function(a,b){var c=this.board.getAbsX(a),e=this.board.getAbsY(b),f=this.board.getCellSize(),g=this.board.theme.get("stoneRadius",f),h=this.board.theme.get("gridLineWidth",f),i=this.board.theme.get("gridLineColor"),j=this.board.theme.get("starRadius",f),k=this.board.theme.get("starColor"),l=this.board.theme.get("canvasTranslate",f,h),m=this.board.theme.get("starPoints",this.board.width,this.board.height),n=0===a?c:c-g,o=a===this.board.width-1?c:c+g,p=0===b?e:e-g,q=b===this.board.height-1?e:e+g;this.context.translate(l,l),this.context.beginPath(),this.context.lineWidth=h,this.context.strokeStyle=i,this.context.moveTo(n,e),this.context.lineTo(o,e),this.context.moveTo(c,p),this.context.lineTo(c,q),this.context.stroke();for(var r in m)m[r].x==a&&m[r].y==b&&d.call(this,a,b,j,k);this.context.translate(-l,-l)},e}]),b.module("ngGo.Board.Layer.HoverLayer.Directive",["ngGo.Board.Layer.HoverLayer.Service"]).directive("hoverlayer",["HoverLayer",function(b){return{restrict:"E",template:"<canvas></canvas>",link:function(c,d,e){if(!c.Board)return void console.warn("No board present in scope for hover layer");var f=a.pixelRatio||1,g=e.name||"hover",h=d.find("canvas"),i=h[0].getContext("2d");f>1&&i.scale(f,f),c.$on("ngGo.board.resize",function(a,b,c){h.attr("width",b*f),h.attr("height",c*f),h.css({width:b,height:c})}),c.Board.layers[g]=new b(c.Board,i)}}}]),b.module("ngGo.Board.Layer.HoverLayer.Service",["ngGo","ngGo.Board.Layer.Service","ngGo.Board.Object.Markup.Service","ngGo.Board.Object.StoneFaded.Service"]).factory("HoverLayer",["BoardLayer","Markup","StoneFaded",function(a,c,d){var e=function(b,c){this.restore=[],a.call(this,b,c)};return b.extend(e.prototype,a.prototype),e.prototype.add=function(a,e,f){if(this.grid.isOnGrid(a,e)){if(this.remove(a,e),f.object={x:a,y:e},"stones"==f.type)f.objectClass=d,f.object.color=f.value;else{if("markup"!=f.type)return void console.warn("Unknown hover type",f.type);f.objectClass=c,"object"==typeof f.value?f.object=b.extend(f.object,f.value):f.object.type=f.value}this.board.has(f.type,a,e)&&(this.restore.push({x:a,y:e,layer:f.type,value:this.board.get(f.type,a,e)}),this.board.remove(f.type,a,e)),this.grid.set(a,e,f),f.objectClass.draw.call(this,f.object)}},e.prototype.remove=function(a,b){if(this.grid.has(a,b)){var c=this.grid.get(a,b);c.objectClass.clear.call(this,c.object);for(var d=0;d<this.restore.length;d++)this.restore[d].x==a&&this.restore[d].y==b&&(this.board.add(this.restore[d].layer,this.restore[d].x,this.restore[d].y,this.restore[d].value),this.restore.splice(d,1))}},e.prototype.removeAll=function(){if(!this.grid.isEmpty()){this.clear(),this.grid.clear();for(var a=0;a<this.restore.length;a++)this.board.add(this.restore[a].layer,this.restore[a].x,this.restore[a].y,this.restore[a].value);this.restore=[]}},e.prototype.draw=function(){if(0!==this.board.drawWidth&&0!==this.board.drawheight)for(var a=this.grid.all("hover"),b=0;b<a.length;b++)a.objectClass.draw.call(this,a.object)},e}]),b.module("ngGo.Board.Layer.MarkupLayer.Directive",["ngGo.Board.Layer.MarkupLayer.Service"]).directive("markuplayer",["MarkupLayer",function(b){return{restrict:"E",template:"<canvas></canvas>",link:function(c,d,e){if(!c.Board)return void console.warn("No board present in scope for markup layer");var f=a.pixelRatio||1,g=e.name||"markup",h=d.find("canvas"),i=h[0].getContext("2d");f>1&&i.scale(f,f),c.$on("ngGo.board.resize",function(a,b,c){h.attr("width",b*f),h.attr("height",c*f),h.css({width:b,height:c})}),c.Board.layers[g]=new b(c.Board,i)}}}]),b.module("ngGo.Board.Layer.MarkupLayer.Service",["ngGo","ngGo.Board.Layer.Service","ngGo.Board.Object.Markup.Service"]).factory("MarkupLayer",["BoardLayer","Markup",function(a,c){var d=function(b,c){a.call(this,b,c)};return b.extend(d.prototype,a.prototype),d.prototype.setAll=function(a){var b,d=this.grid.compare(a,"type");for(b=0;b<d.remove.length;b++)c.clear.call(this,d.remove[b]);for(b=0;b<d.add.length;b++)c.draw.call(this,d.add[b]);this.grid=a.clone()},d.prototype.draw=function(){if(0!==this.board.drawWidth&&0!==this.board.drawheight)for(var a=this.grid.all("type"),b=0;b<a.length;b++)c.draw.call(this,a[b])},d.prototype.clear=function(){for(var a=this.grid.all("type"),b=0;b<a.length;b++)c.clear.call(this,a[b])},d.prototype.drawCell=function(a,b){0!==this.board.drawWidth&&0!==this.board.drawheight&&this.grid.has(a,b)&&c.draw.call(this,this.grid.get(a,b,"type"))},d.prototype.clearCell=function(a,b){this.grid.has(a,b)&&c.clear.call(this,this.grid.get(a,b,"type"))},d}]),b.module("ngGo.Board.Layer.ScoreLayer.Directive",["ngGo.Board.Layer.ScoreLayer.Service"]).directive("scorelayer",["ScoreLayer",function(b){return{restrict:"E",template:"<canvas></canvas>",link:function(c,d,e){if(!c.Board)return void console.warn("No board present in scope for score layer");var f=a.pixelRatio||1,g=e.name||"score",h=d.find("canvas"),i=h[0].getContext("2d");f>1&&i.scale(f,f),c.$on("ngGo.board.resize",function(a,b,c){h.attr("width",b*f),h.attr("height",c*f),h.css({width:b,height:c})}),c.Board.layers[g]=new b(c.Board,i)}}}]),b.module("ngGo.Board.Layer.ScoreLayer.Service",["ngGo","ngGo.Board.Layer.Service","ngGo.Board.Object.StoneMini.Service","ngGo.Board.Object.StoneFaded.Service"]).factory("ScoreLayer",["BoardLayer","StoneMini","StoneFaded",function(a,c,d){var e=function(b,c){this.points=[],this.captures=[],a.call(this,b,c)};return b.extend(e.prototype,a.prototype),e.prototype.setAll=function(a,b){this.removeAll(),this.points=a.all("color"),this.captures=b.all("color"),this.draw()},e.prototype.removeAll=function(){for(var a=0;a<this.captures.length;a++)this.board.layers.stones.add(this.captures[a].x,this.captures[a].y,this.captures[a].color);this.clear(),this.points=[],this.captures=[]},e.prototype.draw=function(){if(0!==this.board.drawWidth&&0!==this.board.drawheight){var a;for(a=0;a<this.captures.length;a++)this.board.layers.stones.remove(this.captures[a].x,this.captures[a].y),d.draw.call(this,this.captures[a]);for(a=0;a<this.points.length;a++)c.draw.call(this,this.points[a])}},e}]),b.module("ngGo.Board.Layer.ShadowLayer.Directive",["ngGo.Board.Layer.ShadowLayer.Service"]).directive("shadowlayer",["ShadowLayer",function(b){return{restrict:"E",template:"<canvas></canvas>",link:function(c,d,e){if(!c.Board)return void console.warn("No board present in scope for shadow layer");var f=a.pixelRatio||1,g=e.name||"shadow",h=d.find("canvas"),i=h[0].getContext("2d");f>1&&i.scale(f,f),c.$on("ngGo.board.resize",function(a,b,c){h.attr("width",b*f),h.attr("height",c*f),h.css({width:b,height:c})}),c.Board.layers[g]=new b(c.Board,i)}}}]),b.module("ngGo.Board.Layer.ShadowLayer.Service",["ngGo","ngGo.Board.Layer.Service","ngGo.Board.Object.StoneShadow.Service"]).factory("ShadowLayer",["BoardLayer","StoneShadow",function(a,c){var d=function(b,c){a.call(this,b,c)};return b.extend(d.prototype,a.prototype),d.prototype.add=function(a){a.shadow===!1||"undefined"!=typeof a.alpha&&a.alpha<1||(this.grid.set(a.x,a.y,a.color),c.draw.call(this,a))},d.prototype.remove=function(a){this.grid.unset(a.x,a.y),this.redraw()},d.prototype.draw=function(){if(0!==this.board.drawWidth&&0!==this.board.drawheight){var a=this.board.theme.get("shadowSize",this.board.getCellSize());this.context.setTransform(1,0,0,1,a,a);for(var b=this.grid.all("color"),d=0;d<b.length;d++)c.draw.call(this,b[d])}},d}]),b.module("ngGo.Board.Layer.StonesLayer.Directive",["ngGo.Board.Layer.StonesLayer.Service"]).directive("stoneslayer",["StonesLayer",function(b){return{restrict:"E",template:"<canvas></canvas>",link:function(c,d,e){if(!c.Board)return void console.warn("No board present in scope for stones layer");var f=a.pixelRatio||1,g=e.name||"stones",h=d.find("canvas"),i=h[0].getContext("2d");f>1&&i.scale(f,f),c.$on("ngGo.board.resize",function(a,b,c){h.attr("width",b*f),h.attr("height",c*f),h.css({width:b,height:c})}),c.Board.layers[g]=new b(c.Board,i)}}}]),b.module("ngGo.Board.Layer.StonesLayer.Service",["ngGo","ngGo.Board.Layer.Service","ngGo.Board.Object.Stone.Service"]).factory("StonesLayer",["BoardLayer","Stone","StoneColor",function(a,c,d){var e=function(b,c){a.call(this,b,c),this.grid.whenEmpty(d.NONE)};return b.extend(e.prototype,a.prototype),e.prototype.setAll=function(a){var b,d=this.grid.compare(a,"color");for(b=0;b<d.remove.length;b++)c.clear.call(this,d.remove[b]);for(b=0;b<d.add.length;b++)c.draw.call(this,d.add[b]);this.grid=a.clone()},e.prototype.draw=function(){if(0!==this.board.drawWidth&&0!==this.board.drawheight)for(var a=this.grid.all("color"),b=0;b<a.length;b++)c.draw.call(this,a[b])},e.prototype.drawCell=function(a,b){0!==this.board.drawWidth&&0!==this.board.drawheight&&this.grid.has(a,b)&&c.draw.call(this,this.grid.get(a,b,"color"))},e.prototype.clearCell=function(a,b){this.grid.has(a,b)&&c.clear.call(this,this.grid.get(a,b,"color"))},e}]),b.module("ngGo.Board.Object.Service",["ngGo","ngGo.Board.DefaultClearHandler.Service"]).factory("BoardObject",["DefaultClearHandler",function(a){var b={draw:function(){0===this.board.drawWidth||0===this.board.drawheight},clear:function(b){a.call(this,this.context,b)}};return b}]),b.module("ngGo.Board.Object.Coordinates.Service",["ngGo"]).factory("Coordinates",function(){var a={draw:function(){if(0!==this.board.drawWidth&&0!==this.board.drawheight){var a=this.board.getAbsX(-.75),b=this.board.getAbsX(this.board.width-.25),c=this.board.getAbsY(-.75),d=this.board.getAbsY(this.board.height-.25),e="A".charCodeAt(0),f="I".charCodeAt(0),g=this.board.getCellSize(),h=(this.board.theme.get("stoneRadius",g),this.board.theme.get("coordinatesColor")),i=this.board.theme.get("coordinatesSize",g),j=this.board.theme.get("font")||"";this.context.fillStyle=h,this.context.textBaseline="middle",this.context.textAlign="center",this.context.font=i+"px "+j;var k,l,m;for(k=0;k<this.board.height;k++){m=this.board.getAbsX(k);var n=0===this.board.section.bottom?this.board.height-k:k+1;this.context.fillText(n,b,m),this.context.fillText(n,a,m)}for(k=0;k<this.board.width;k++){l=this.board.getAbsY(k);var o=e+k;o>=f&&o++,this.context.fillText(String.fromCharCode(o),l,c),this.context.fillText(String.fromCharCode(o),l,d)}}}};return a}),b.module("ngGo.Board.Object.Markup.Service",["ngGo","ngGo.Board.Object.Service"]).factory("Markup",["MarkupTypes","BoardObject",function(a,b){var c=Math.cos(Math.PI/4),d=Math.cos(Math.PI/6),e=function(a){var b=this.board.getAbsX(a.x),c=this.board.getAbsY(a.y),e=this.board.getCellSize(),f=Math.round(this.board.theme.get("stoneRadius",e)*this.board.theme.get("markupTriangleScale"));a.scale&&(f=Math.round(f*a.scale));var g=a.lineWidth||this.board.theme.get("markupLineWidth",e)||1,h=a.color||this.board.theme.get("markupColor",this.board.getStoneColor(a.x,a.y)),i=this.board.theme.get("canvasTranslate",e,g);this.context.translate(i,i),this.context.strokeStyle=h,this.context.lineWidth=g,this.context.beginPath(),this.context.moveTo(b,c-f),this.context.lineTo(b-Math.round(f*d),c+Math.round(f/2)),this.context.lineTo(b+Math.round(f*d),c+Math.round(f/2)),this.context.closePath(),this.context.stroke(),this.context.translate(-i,-i)},f=function(a){var b=this.board.getAbsX(a.x),d=this.board.getAbsY(a.y),e=this.board.getCellSize(),f=Math.round(this.board.theme.get("stoneRadius",e)*this.board.theme.get("markupSquareScale"));a.scale&&(f=Math.round(f*a.scale));var g=Math.round(f*c),h=a.lineWidth||this.board.theme.get("markupLineWidth",e)||1,i=a.color||this.board.theme.get("markupColor",this.board.getStoneColor(a.x,a.y)),j=this.board.theme.get("canvasTranslate",e,h);this.context.translate(j,j),this.context.strokeStyle=i,this.context.lineWidth=h,this.context.beginPath(),this.context.rect(b-g,d-g,2*g,2*g),this.context.stroke(),this.context.translate(-j,-j)},g=function(a){var b=this.board.getAbsX(a.x),c=this.board.getAbsY(a.y),d=this.board.getCellSize(),e=Math.round(this.board.theme.get("stoneRadius",d)*this.board.theme.get("markupCircleScale"));a.scale&&(e=Math.round(e*a.scale));var f=a.lineWidth||this.board.theme.get("markupLineWidth",d)||1,g=a.color||this.board.theme.get("markupColor",this.board.getStoneColor(a.x,a.y)),h=this.board.theme.get("canvasTranslate");this.context.translate(h,h),this.context.strokeStyle=g,this.context.lineWidth=f,this.context.beginPath(),this.context.arc(b,c,e,0,2*Math.PI,!0),this.context.stroke(),this.context.translate(-h,-h)},h=function(a){var b=this.board.getAbsX(a.x),d=this.board.getAbsY(a.y),e=this.board.getCellSize(),f=Math.round(this.board.theme.get("stoneRadius",e)*this.board.theme.get("markupMarkScale"));a.scale&&(f=Math.round(f*a.scale));var g=Math.round(f*c),h=a.lineWidth||this.board.theme.get("markupLineWidth",e)||1,i=a.lineCap||this.board.theme.get("markupLineCap"),j=a.color||this.board.theme.get("markupColor",this.board.getStoneColor(a.x,a.y)),k=this.board.theme.get("canvasTranslate",e,h);this.context.translate(k,k),this.context.strokeStyle=j,this.context.lineWidth=h,this.context.lineCap=i,this.context.beginPath(),this.context.moveTo(b-g,d-g),this.context.lineTo(b+g,d+g),this.context.moveTo(b+g,d-g),this.context.lineTo(b-g,d+g),this.context.stroke(),this.context.translate(-k,-k)},i=function(a){var b=this.board.getAbsX(a.x),c=this.board.getAbsY(a.y),d=this.board.getCellSize(),e=Math.round(this.board.theme.get("stoneRadius",d)*this.board.theme.get("markupCircleScale"));a.scale&&(e=Math.round(e*a.scale));var f=a.lineWidth||this.board.theme.get("markupLineWidth",d)||1,g=a.color||this.board.theme.get("markupColor",this.board.getStoneColor(a.x,a.y)),h=this.board.theme.get("canvasTranslate");this.context.translate(h,h),this.context.fillStyle=g,this.context.lineWidth=f,this.context.beginPath(),this.context.arc(b,c,e,0,2*Math.PI,!0),this.context.fill(),this.context.translate(-h,-h)},j=function(a){var b=this.board.getAbsX(a.x),c=this.board.getAbsY(a.y),d=this.board.getCellSize(),e=Math.round(this.board.theme.get("stoneRadius",d)*this.board.theme.get("markupLastScale"));a.scale&&(e=Math.round(e*a.scale));var f=a.color||this.board.theme.get("markupColor",this.board.getStoneColor(a.x,a.y)),g=this.board.theme.get("canvasTranslate",d);this.context.translate(g,g),this.context.fillStyle=f,this.context.beginPath(),this.context.moveTo(b,c),this.context.lineTo(b+e,c),this.context.lineTo(b,c+e),this.context.closePath(),this.context.fill(),this.context.translate(-g,-g)},k=function(a){var b=this.board.getAbsX(a.x),c=this.board.getAbsY(a.y),d=this.board.getCellSize(),e=Math.round(this.board.theme.get("stoneRadius",d)*this.board.theme.get("markupSmileyScale"));a.scale&&(e=Math.round(e*a.scale));var f=a.lineWidth||this.board.theme.get("markupLineWidth",d)||1,g=a.color||this.board.theme.get("markupColor",this.board.getStoneColor(a.x,a.y)),h=this.board.theme.get("canvasTranslate");this.context.translate(h,h),this.context.strokeStyle=g,this.context.lineWidth=f,this.context.lineCap="round",this.context.beginPath(),this.context.arc(b-e/3,c-e/3,e/6,0,2*Math.PI,!0),this.context.stroke(),this.context.beginPath(),this.context.arc(b+e/3,c-e/3,e/6,0,2*Math.PI,!0),this.context.stroke(),this.context.beginPath(),this.context.moveTo(b-e/1.6,c+e/8),this.context.bezierCurveTo(b-e/1.8,c+e/1.5,b+e/1.8,c+e/1.5,b+e/1.6,c+e/8),this.context.stroke(),this.context.translate(-h,-h)},l=function(a){var b=this.board.getAbsX(a.x),c=this.board.getAbsY(a.y),d=this.board.getCellSize(),e=Math.round(this.board.theme.get("stoneRadius",d)*this.board.theme.get("markupSmileyScale"));a.scale&&(e=Math.round(e*a.scale));var f=a.lineWidth||this.board.theme.get("markupLineWidth",d)||1,g=a.color||this.board.theme.get("markupColor",this.board.getStoneColor(a.x,a.y)),h=this.board.theme.get("canvasTranslate");this.context.translate(h,h),this.context.strokeStyle=g,this.context.lineWidth=f,this.context.lineCap="round",this.context.beginPath(),this.context.arc(b-e/3,c-e/3,e/6,0,2*Math.PI,!0),this.context.stroke(),this.context.beginPath(),this.context.arc(b+e/3,c-e/3,e/6,0,2*Math.PI,!0),this.context.stroke(),this.context.beginPath(),this.context.moveTo(b-e/1.6,c+e/1.5-1),this.context.bezierCurveTo(b-e/1.8,c+e/8-1,b+e/1.8,c+e/8-1,b+e/1.6,c+e/1.5-1),this.context.stroke(),this.context.translate(-h,-h)},m=function(a){var b=this.board.getAbsX(a.x),c=this.board.getAbsY(a.y),d=this.board.getCellSize(),e=this.board.theme.get("stoneRadius",d);a.scale&&(e=Math.round(e*a.scale));var f=a.font||this.board.theme.get("font")||"",g=a.color||this.board.theme.get("markupColor",this.board.getStoneColor(a.x,a.y)),h=this.board.theme.get("canvasTranslate");this.board.layers.grid&&!this.board.layers.stones.has(a.x,a.y)&&this.board.layers.grid.clearCell(a.x,a.y),this.context.translate(h,h),this.context.fillStyle=g,this.context.textBaseline="middle",this.context.textAlign="center","number"==typeof a.text&&(a.text=a.text.toString()),this.context.font=1==a.text.length?Math.round(1.5*e)+"px "+f:2==a.text.length?Math.round(1.2*e)+"px "+f:e+"px "+f,this.context.beginPath(),this.context.fillText(a.text,b,c,2*e),this.context.translate(-h,-h)},n=function(a){if(this.board.layers.grid&&!this.board.layers.stones.has(a.x,a.y)){{this.board.theme.get("stoneRadius",this.board.getCellSize())}this.board.layers.grid.redrawCell(a.x,a.y)}},o={draw:function(b){if(0!==this.board.drawWidth&&0!==this.board.drawheight)switch(b.type){case a.TRIANGLE:e.call(this,b);break;case a.SQUARE:f.call(this,b);break;case a.CIRCLE:g.call(this,b);break;case a.MARK:h.call(this,b);break;case a.SELECT:i.call(this,b);break;case a.HAPPY:k.call(this,b);break;case a.SAD:l.call(this,b);break;case a.LAST:j.call(this,b);break;case a.LABEL:b.text=b.text||"",m.call(this,b)}},clear:function(c){b.clear.call(this,c),c.type==a.LABEL&&n.call(this,c)}};return o}]),b.module("ngGo.Board.Object.Stone.Service",["ngGo","ngGo.Board.Object.Service","ngGo.Board.ShellPattern.Service"]).factory("Stone",["$injector","BoardObject","StoneColor","ShellPattern",function(a,b,c,d){var e,f=[{lines:[.1,.12,.11,.1,.09,.09,.09,.09],factor:.25,thickness:1.75},{lines:[.1,.09,.08,.07,.06,.06,.06,.06,.06,.06,.06],factor:.2,thickness:1.5},{lines:[.12,.14,.13,.12,.12,.12],factor:.3,thickness:2}],g=function(a){var b=this.board.getAbsX(a.x),d=this.board.getAbsY(a.y),e=this.board.getCellSize(),f=this.board.theme.get("stoneRadius",e);a.scale&&(f=Math.round(f*a.scale));var g=a.color*this.board.colorMultiplier,h=this.board.theme.get("markupLinesWidth",e)||1;canvasTranslate=this.board.theme.get("canvasTranslate"),this.context.translate(canvasTranslate,canvasTranslate),a.alpha&&a.alpha<1&&(this.context.globalAlpha=a.alpha),this.context.fillStyle=this.board.theme.get(g==c.W?"stoneColorMonoWhite":"stoneColorMonoBlack"),this.context.beginPath(),this.context.arc(b,d,Math.max(0,f-h),0,2*Math.PI,!0),this.context.fill(),this.context.lineWidth=h,this.context.strokeStyle="#000",this.context.stroke(),a.alpha&&a.alpha<1&&(this.context.globalAlpha=1),this.context.translate(-canvasTranslate,-canvasTranslate)},h=function(a){var b=this.board.getAbsX(a.x),d=this.board.getAbsY(a.y),e=this.board.getCellSize(),f=this.board.theme.get("stoneRadius",e);
a.scale&&(f=Math.round(f*a.scale));var g=a.color*this.board.colorMultiplier,h=this.board.theme.get("canvasTranslate");this.context.translate(h,h),a.alpha&&a.alpha<1&&(this.context.globalAlpha=a.alpha),this.context.beginPath(),g==c.W?(this.context.fillStyle=ctx.createRadialGradient(b-2*f/5,d-2*f/5,f/3,b-f/5,d-f/5,5*f/5),this.context.fillStyle.addColorStop(0,"#fff"),this.context.fillStyle.addColorStop(1,"#aaa")):(this.context.fillStyle=ctx.createRadialGradient(b-2*f/5,d-2*f/5,1,b-f/5,d-f/5,4*f/5),this.context.fillStyle.addColorStop(0,"#666"),this.context.fillStyle.addColorStop(1,"#000")),this.context.arc(b,d,Math.max(0,f-.5),0,2*Math.PI,!0),this.context.fill(),a.alpha&&a.alpha<1&&(this.context.globalAlpha=1),this.context.translate(-h,-h)},i=function(a){var b=this.board.getAbsX(a.x),g=this.board.getAbsY(a.y),h=this.board.getCellSize(),i=this.board.theme.get("stoneRadius",h);a.scale&&(i=Math.round(i*a.scale)),e=e||Math.ceil(9999999*Math.random());var j=a.color*this.board.colorMultiplier,k=this.board.theme.get("canvasTranslate");if(this.context.translate(k,k),a.alpha&&a.alpha<1&&(this.context.globalAlpha=a.alpha),this.context.beginPath(),this.context.fillStyle=j==c.W?"#aaa":"#000",this.context.arc(b,g,Math.max(0,i-.5),0,2*Math.PI,!0),this.context.fill(),j==c.W){var l=e%(f.length+a.x*this.board.width+a.y)%f.length,m=this.board.width*this.board.height+a.x*this.board.width+a.y,n=2/m*(e%m);d.call(f[l],this.context,b,g,i,n),this.context.beginPath(),this.context.fillStyle=this.context.createRadialGradient(b-2*i/5,g-2*i/5,i/3,b-i/5,g-i/5,5*i/5),this.context.fillStyle.addColorStop(0,"rgba(255,255,255,0.9)"),this.context.fillStyle.addColorStop(1,"rgba(255,255,255,0)"),this.context.arc(b,g,Math.max(0,i-.5),0,2*Math.PI,!0),this.context.fill()}else this.context.beginPath(),this.context.fillStyle=this.context.createRadialGradient(b+2*i/5,g+2*i/5,0,b+i/2,g+i/2,i),this.context.fillStyle.addColorStop(0,"rgba(32,32,32,1)"),this.context.fillStyle.addColorStop(1,"rgba(0,0,0,0)"),this.context.arc(b,g,Math.max(0,i-.5),0,2*Math.PI,!0),this.context.fill(),this.context.beginPath(),this.context.fillStyle=this.context.createRadialGradient(b-2*i/5,g-2*i/5,1,b-i/2,g-i/2,3*i/2),this.context.fillStyle.addColorStop(0,"rgba(64,64,64,1)"),this.context.fillStyle.addColorStop(1,"rgba(0,0,0,0)"),this.context.arc(b,g,Math.max(0,i-.5),0,2*Math.PI,!0),this.context.fill();a.alpha&&a.alpha<1&&(this.context.globalAlpha=1),this.context.translate(-k,-k)},j={draw:function(b){var c=this.board.theme.get("stoneStyle");switch(c){case"shell":i.call(this,b);break;case"glass":h.call(this,b);break;case"mono":g.call(this,b);break;default:var d=a.get(c);d&&d.call(this,b)}this.board.theme.get("stoneShadow")&&b.shadow!==!1&&this.board.layers.shadow.add(b)},clear:function(a){b.clear.call(this,a),this.board.theme.get("stoneShadow")&&a.shadow!==!1&&this.board.layers.shadow.remove(a)}};return j}]),b.module("ngGo.Board.Object.StoneFaded.Service",["ngGo","ngGo.Board.Object.Stone.Service"]).factory("StoneFaded",["Stone",function(a){return StoneFaded={draw:function(b){b.alpha||(b.alpha=this.board.theme.get("stoneFadedAlpha",b.color)),b.shadow=!1,a.draw.call(this,b)},clear:function(b){b.shadow=!1,a.clear.call(this,b)}}}]),b.module("ngGo.Board.Object.StoneMini.Service",["ngGo","ngGo.Board.Object.Stone.Service"]).factory("StoneMini",["Stone",function(a){return StoneMini={draw:function(b){b.scale||(b.scale=this.board.theme.get("stoneMiniScale")),b.shadow=!1,a.draw.call(this,b)},clear:function(b){b.shadow=!1,a.clear.call(this,b)}}}]),b.module("ngGo.Board.Object.StoneShadow.Service",["ngGo","ngGo.Board.Object.Service"]).factory("StoneShadow",["BoardObject",function(){var a={draw:function(a){if(!(a.alpha&&a.alpha<1||a.shadow===!1)){var b=this.board.getAbsX(a.x),c=this.board.getAbsY(a.y),d=this.board.getCellSize(),e=Math.max(0,this.board.theme.get("stoneRadius",d)-.5);a.scale&&(e=Math.round(e*a.scale));var f=this.board.theme.get("shadowBlur",d),g=this.board.theme.get("shadowColor"),h=this.board.theme.get("shadowTransparentColor");this.context.fillStyle=this.context.createRadialGradient(b,c,e-1-f,b,c,e+f),this.context.fillStyle.addColorStop(0,g),this.context.fillStyle.addColorStop(1,h),this.context.beginPath(),this.context.arc(b,c,e+f,0,2*Math.PI,!0),this.context.fill()}},clear:function(a){if(!(a.alpha&&a.alpha<1||a.shadow===!1)){var b=this.board.getAbsX(a.x),c=this.board.getAbsY(a.y),d=this.board.getCellSize(),e=this.board.theme.get("stoneRadius",d);this.context.clearRect(b-1.2*e,c-1.2*e,2.4*e,2.4*e)}}};return a}]),b.module("ngGo.Board.ShellPattern.Service",["ngGo"]).factory("ShellPattern",function(){var a=function(a,b,c,d,e,f){a.strokeStyle="rgba(64,64,64,0.2)",a.lineWidth=d/30*this.thickness,a.beginPath(),d-=Math.max(1,a.lineWidth);var g,h,i=b+d*Math.cos(e*Math.PI),j=c+d*Math.sin(e*Math.PI),k=b+d*Math.cos(f*Math.PI),l=c+d*Math.sin(f*Math.PI);k>i?(g=(l-j)/(k-i),h=Math.atan(g)):k==i?h=Math.PI/2:(g=(l-j)/(k-i),h=Math.atan(g)-Math.PI);var m=this.factor*d,n=Math.sin(h)*m,o=Math.cos(h)*m,p=i+n,q=j-o,r=k+n,s=l-o;a.moveTo(i,j),a.bezierCurveTo(p,q,r,s,k,l),a.stroke()};return function(b,c,d,e,f){for(var g=f,h=f,i=0;i<this.lines.length;i++)g+=this.lines[i],h-=this.lines[i],a.call(this,b,c,d,e,g,h)}}),b.module("ngGo.Board.Theme.Service",["ngGo"]).provider("BoardTheme",["StoneColor",function(a){var c={font:"Calibri",stoneStyle:"shell",stoneShadow:!0,stoneMiniScale:.5,stoneFadedAlpha:function(b){return b==a.B?.3:.4},stoneColorMonoBlack:"#000",stoneColorMonoWhite:"#fff",stoneRadius:function(a){return Math.floor(a/2)},shadowColor:"rgba(62,32,32,0.3)",shadowTransparentColor:"rgba(62,32,32,0)",shadowSize:function(a){return Math.floor(a/20)},shadowBlur:function(a){return a/20},markupColor:function(b){return b==a.B?"rgba(255,255,255,0.9)":"rgba(0,0,0,0.9)"},markupVariationColor:"rgba(86,114,30,0.9)",markupTriangleScale:.85,markupSquareScale:.85,markupCircleScale:.55,markupMarkScale:.75,markupSmileyScale:.85,markupLastScale:.7,markupLineCap:"square",markupLineWidth:function(a){return Math.max(1,Math.floor(a/16))},problemSolutionMarkup:"select",problemSolutionColor:"rgba(86,114,30,0.9)",problemSolutionScale:.5,problemInvalidMarkup:"mark",problemInvalidColor:"rgba(237,9,15,0.8)",problemInvalidScale:.3,gridLineColor:"rgba(101,69,37,0.4)",gridLineWidth:1,starPoints:function(a,b){return a==b&&19==a?[{x:3,y:3},{x:9,y:3},{x:15,y:3},{x:3,y:9},{x:9,y:9},{x:15,y:9},{x:3,y:15},{x:9,y:15},{x:15,y:15}]:a==b&&13==a?[{x:3,y:3},{x:9,y:3},{x:3,y:9},{x:9,y:9}]:a==b&&9==a?[{x:4,y:4},{x:2,y:2},{x:2,y:6},{x:6,y:2},{x:6,y:6}]:[]},starColor:"rgba(168,132,81,1)",starRadius:function(a){return Math.floor(a/16+1)},coordinatesMargin:.12,coordinatesColor:"rgba(101,69,37,0.4)",coordinatesSize:function(a){return Math.floor(a/3+1)},canvasTranslate:function(a,b){return"undefined"==typeof b&&(b=this.get("gridLineWidth")),b%2*.5}};this.setTheme=function(a){c=b.extend(c,a)},this.$get=["StoneColor",function(){var a=function(a){this.theme=b.extend({},c,a||{})};return a.prototype.get=function(a){if("undefined"==typeof this.theme[a])return"";if("function"==typeof this.theme[a]){var b=[];if(arguments.length>1)for(var c=1;c<arguments.length;c++)b.push(arguments[c]);return this.theme[a].apply(this,b)}return this.theme[a]},a.prototype.set=function(a,b){return this.theme[a]=b,this},a}]}]),b.module("ngGo.Errors.InvalidMoveError.Service",["ngGo"]).factory("InvalidMoveError",["ngGo","StoneColor",function(a,b){var d=function(d,e){if(this.name="InvalidMoveError",this.message="Invalid move detected in kifu.",e.move&&e.move.color!==c&&e.move.x!==c&&e.move.y!==c){var f=e.move.x;e.move.x>7&&f++,f=String.fromCharCode(f+65),this.message+=" Trying to play "+(e.move.color==b.W?"white":"black")+" move on ("+e.move.x+", "+e.move.y+")"}switch(d){case a.error.MOVE_OUT_OF_BOUNDS:this.message+=", but these coordinates are not on the board.";break;case a.error.MOVE_ALREADY_HAS_STONE:this.message+=", but there is already a stone on those coordinates.";break;case a.error.MOVE_IS_SUICIDE:this.message+=", but this move is suicide.";break;case a.error.MOVE_IS_REPEATING:this.message+=", but this position already occured.";break;default:this.message+="."}};return d.prototype=new Error,d.prototype.constructor=d,d}]),b.module("ngGo.Game.Service",["ngGo","ngGo.Game.Node.Service","ngGo.Game.Position.Service","ngGo.Kifu.Blank.Service","ngGo.Kifu.Parser.Service"]).provider("Game",function(){var a={defaultSize:0,defaultKomi:0,defaultHandicap:0,rememberPath:!0,checkRepeat:"KO",allowRewrite:!1,allowSuicide:!1};this.setConfig=function(c){a=b.extend(a,c)},this.$get=["ngGo","StoneColor","GameNode","GamePosition","KifuParser","KifuBlank",function(d,e,f,g,h,i){var j=function(){this.info.board||(this.info.board={}),this.info.game||(this.info.game={}),"undefined"==typeof this.info.board.width&&(this.info.board.width=this.config.defaultSize),"undefined"==typeof this.info.board.height&&(this.info.board.height=this.config.defaultSize),"undefined"==typeof this.info.game.komi&&(this.info.game.komi=this.config.defaultKomi),"undefined"==typeof this.info.game.handicap&&(this.info.game.handicap=this.config.defaultHandicap)},k=function(a){return 0===this.node.children.length?!1:(a===c&&(a=this.node._remembered_path),a=a||0,a>=this.node.children.length||!this.node.children[a]?!1:(this.path.m++,this.node.children.length>1&&(this.path[this.path.m]=a),this.node=this.node.children[a],!0))},l=function(){return this.node.parent?(this.path[this.path.m]!==c&&delete this.path[this.path.m],this.path.m--,this.node=this.node.parent,!0):!1},m=function(){this.path={m:0},this.node=this.root,this.setTurn(this.info.game.handicap>1?e.W:e.B)},n=function(){1!=this.history.length&&(this.history=[],this.history.push(new g),this.info.board&&this.history[0].setSize(this.info.board.width,this.info.board.height))},o=function(a){a||(a=this.position.clone(),a.switchTurn()),this.history.push(a)},p=function(){return 0===this.history.length?null:this.history.pop()},q=function(){this.node.parent&&(this.node.parent._remembered_path=this.node.parent.children.indexOf(this.node));var a,b=this.position.clone();if(this.node.move)if(this.node.move.pass)b.setTurn(-this.node.move.color);else if(!this.isValidMove(this.node.move.x,this.node.move.y,this.node.move.color,b))return void console.warn("Invalid move detected in game record");if(this.node.turn&&b.setTurn(this.node.turn),this.node.setup)for(a in this.node.setup)b.stones.set(this.node.setup[a].x,this.node.setup[a].y,this.node.setup[a].color);if(this.node.markup)for(a in this.node.markup)b.markup.set(this.node.markup[a].x,this.node.markup[a].y,this.node.markup[a]);o.call(this,b)},r=function(c,d){this.config=b.extend({},a,d||{}),this.load(c),Object.defineProperty(this,"position",{get:function(){return this.history[this.history.length-1]},set:function(a){this.history[this.history.length]=a}})};return r.prototype.init=function(){this.error=0,this.info={},this.root=null,this.node=null,this.path={},this.history=[]},r.prototype.load=function(a){return this.init(),this.fromData(a),n.call(this),this.hasTree()},r.prototype.hasTree=function(){return null!==this.root},r.prototype.clone=function(){for(var a=new r,c=Object.getOwnPropertyNames(this),d=0;d<c.length;d++)a[d]=b.copy(this[d]);return a},r.prototype.fromData=function(a){if(a)if("string"==typeof a){var b=a.charAt(0);"("==b?this.fromSgf(a):"{"==b&&this.fromJgf(a)}else"object"==typeof a&&this.fromJgf(a)},r.prototype.fromSgf=function(a){var b=h.sgf2jgf(a);b&&this.fromJgf(b)},r.prototype.fromJgf=function(a){"string"==typeof a&&(a=JSON.parse(a)),"string"==typeof a.tree&&(a.tree="["==a.tree.charAt(0)?JSON.parse(a.tree):[]);for(var c in a)"tree"!=c&&(this.info[c]=b.copy(a[c]));j.call(this),this.root=new f,a.tree&&this.root.fromJgf(a.tree)},r.prototype.toSgf=function(){return h.jgf2sgf(this.toJgf())},r.prototype.toJgf=function(a){for(var c=i.jgf(),d=Object.getOwnPropertyNames(this),e=0;e<d.length;e++)"root"!=e&&(c[e]=c[e]?b.extend(c[e],this[e]):b.copy(this[e]));return c.tree=this.root.toJgf(),a?JSON.stringify(c):c},r.prototype.getError=function(){return this.error},r.prototype.getNode=function(){return this.node},r.prototype.getPosition=function(){return this.position},r.prototype.getPath=function(){return this.path},r.prototype.isPath=function(a){return this.path==a},r.prototype.getPosition=function(){return this.position},r.prototype.getKomi=function(){return this.info.game.komi?parseFloat(this.info.game.komi):0},r.prototype.setKomi=function(a){this.info.game.komi=a?parseFloat(a):this.config.defaultKomi},r.prototype.getTurn=function(){return this.history.length?this.position.getTurn():e.B},r.prototype.setTurn=function(a){this.history.length&&this.position.setTurn(a)},r.prototype.getCaptureCount=function(){var a={};a[e.B]=0,a[e.W]=0;for(var b=0;b<this.history.length;b++)a[e.B]+=this.history[b].getCaptureCount(e.B),a[e.W]+=this.history[b].getCaptureCount(e.W);return a},r.prototype.get=function(a){if(a){"string"==typeof a&&(a=a.split("."));for(var b,c=this.info,d=0;d<a.length;d++){if(b=a[d],d+1==a.length)return c[b];if("object"!=typeof c[b])return void console.warn("Game property",b,"is not an object");c=c[b]}}},r.prototype.isOnBoard=function(a,b){return a>=0&&b>=0&&a<this.info.board.width&&b<this.info.board.height},r.prototype.isMoveVariation=function(a,b){return this.node?this.node.isMoveVariation(a,b):-1},r.prototype.isRepeatingPosition=function(a){var b;if("KO"==this.checkRepeat&&this.history.length-2>=0)b=this.history.length-2;else{if("ALL"!=this.checkRepeat)return!1;b=0}for(var c=this.history.length-2;c>=b;c--)if(a.isSameAs(this.history[c]))return!0;return!1},r.prototype.isValidMove=function(a,b,c,f){if(!this.isOnBoard(a,b))return this.error=d.error.MOVE_OUT_OF_BOUNDS,!1;if(!this.allowRewrite&&this.position.stones.get(a,b)!=e.NONE)return this.error=d.error.MOVE_ALREADY_HAS_STONE,!1;c=c||this.position.getTurn(),f=f||this.position.clone(),f.stones.set(a,b,c);var g=f.captureAdjacent(a,b);if(!g&&!f.hasLiberties(a,b)){if(!this.allowSuicide)return this.error=d.error.MOVE_IS_SUICIDE,!1;f.captureGroup(a,b)}return this.checkRepeat&&this.isRepeatingPosition(f,a,b)?(this.error=d.error.MOVE_IS_REPEATING,!1):(f.setTurn(-c),f)},r.prototype.addStone=function(a,b,c){if(!this.position.stones.is(a,b,c)){if("undefined"==typeof this.node.setup){if(this.node.move){o.call(this);var d=new f;d.appendTo(this.node),this.node=d}this.node.setup=[]}this.position.stones.set(a,b,c),this.node.setup.push(this.position.stones.get(a,b,"color"))}},r.prototype.addMarkup=function(a,b,c){"undefined"==typeof this.node.markup&&(this.node.markup=[]),this.position.markup.set(a,b,c),this.node.markup.push(this.position.markup.get(a,b,"type"))},r.prototype.removeStone=function(a,b){var c=!1;if("undefined"!=typeof this.node.setup)for(var d=0;d<this.node.setup.length;d++)if(a==this.node.setup[d].x&&b==this.node.setup[d].y){this.node.setup.splice(d,1),this.position.stones.unset(a,b),c=!0;break}c||this.addStone(a,b,e.NONE)},r.prototype.removeMarkup=function(a,b){if("undefined"!=typeof this.node.markup)for(var c=0;c<this.node.markup.length;c++)if(a==this.node.markup[c].x&&b==this.node.markup[c].y){this.node.markup.splice(c,1),this.position.markup.unset(a,b);break}},r.prototype.hasStone=function(a,b,c){return"undefined"!=typeof c?this.position.stones.is(a,b,c):this.position.stones.has(a,b)},r.prototype.hasMarkup=function(a,b,c){return"undefined"!=typeof c?this.position.markup.is(a,b,c):this.position.markup.has(a,b)},r.prototype.play=function(a,b,c){c=c||this.position.getTurn();var d=this.isValidMove(a,b,c);if(!d)return!1;o.call(this,d);var e=new f({move:{x:a,y:b,color:c}});return this.node._remembered_path=e.appendTo(this.node),this.node=e,!0},r.prototype.pass=function(a){a=a||this.position.getTurn();var b=this.position.clone();b.setTurn(-a),o.call(this,b);var c=new f({move:{pass:!0,color:a}});this.node._remembered_path=c.appendTo(this.node),this.node=c},r.prototype.next=function(a){k.call(this,a)&&q.call(this)},r.prototype.previous=function(){l.call(this)&&p.call(this)},r.prototype.last=function(){for(;k.call(this);)q.call(this)},r.prototype.first=function(){m.call(this),n.call(this),o.call(this),q.call(this)},r.prototype.goto=function(a){if("undefined"==typeof a)return null;if("function"==typeof a&&(a=a.call(this)),"number"==typeof a){var c=a;a=b.copy(this.path),a.m=c||0}m.call(this),n.call(this),o.call(this),q.call(this);for(var d=0;d<a.m&&k.call(this,a[d+1]);d++)q.call(this)},r.prototype.lastFork=function(){for(;execPrevious.call(this)&&1==this.node.children.length;);},r}]}),b.module("ngGo.Game.Node.Service",["ngGo"]).factory("GameNode",["StoneColor",function(a){var c="a".charCodeAt(0),d=function(a,b){return String.fromCharCode(c+a)+String.fromCharCode(c+b)},e=function(a,b){return a.charCodeAt(b)-c},f=function(a,b){return b=b||{},""===a||"pass"==a?b.pass=!0:(b.x=e(a,0),b.y=e(a,1)),b},g=function(b){return b==a.B?"B":b==a.W?"W":""},h=function(b){return"B"==b?a.B:"W"==b?a.W:a.NONE},i=function(a){var c=b.copy(a),e=g(a.color);return""===e?null:(c[e]=a.pass===!0?"pass":d(a.x,a.y),delete c.x,delete c.y,delete c.color,c)},j=function(a){var b,c,d,e=["W","B"];for(b in e)if(c=e[b],a[c]){d=a[c];break}return d?(delete a[c],a.color=h(c),f(d,a)):null},k=function(a){var b,c,e={};for(b in a)c=g(a[b].color)||"E","undefined"==typeof e[c]&&(e[c]=[]),e[c].push(d(a[b].x,a[b].y));return e},l=function(a){var b,c,d,e=[];for(c in a){d=h(c);for(b in a[c])e.push(f(a[c][b],{color:d}))}return e},m=function(a){var b,c,e={};for(b in a)if(c=a[b].type,"undefined"==typeof e[c]&&(e[c]=[]),"LB"==c){var f=d(a[b].x,a[b].y)+":"+a[b].text;e[c].push(f)}else e[c].push(d(a[b].x,a[b].y));return e},n=function(a){var c,d,e=[];for(d in a)if("label"==d)for(c=0;c<a[d].length;c++)!b.isArray(a[d][c])||a[d][c].length<2||e.push(f(a[d][c][0],{type:d,text:a[d][c][1]}));else for(c in a[d])e.push(f(a[d][c],{type:d}));return e},o=function(b){switch(b){case a.W:return"W";case a.B:return"B";default:return""}},p=function(b){switch(b){case"W":return a.W;case"B":return a.B;default:return a.NONE}},q={toJgf:{move:i,setup:k,markup:m,turn:o},fromJgf:{move:j,setup:l,markup:n,turn:p}},r=function(a,b){if(this.parent=b||null,this.children=[],a)for(var c in a)this[c]=a[c]};return r.prototype.getChild=function(a){return a=a||0,this.children[a]?this.children[a]:null},r.prototype.getChildren=function(){return this.children},r.prototype.hasMoveVariations=function(){if(this.children.length<=1)return!1;for(var a=0,b=0;b<this.children.length;b++)if(this.children[b].move&&a++,a>1)return!0;return!1},r.prototype.getMoveVariations=function(){if(0===this.children.length)return!1;for(var a=[],b=0;b<this.children.length;b++)this.children[b].move&&a.push(this.children[b]);return a},r.prototype.isMoveVariation=function(a,b){for(var c in this.children)if(this.children[c].move&&this.children[c].move.x==a&&this.children[c].move.y==b)return c;return-1},r.prototype.remove=function(){if(this.parent){var a=this.parent.children.indexOf(this);-1!==a&&this.parent.children.splice(a,1),this.parent=null}},r.prototype.moveUp=function(){if(this.parent){var a=this.parent.children.indexOf(this);if(a>0){var b=this.parent.children[a-1];this.parent.children[a-1]=this,this.parent.children[a]=b}}},r.prototype.moveDown=function(){if(this.parent){var a=this.parent.children.indexOf(this);if(-1!==a&&a<this.parent.children.length-1){var b=this.parent.children[a+1];this.parent.children[a+1]=this,this.parent.children[a]=b}}},r.prototype.appendTo=function(a){return this.remove(),this.parent=a,a.children.push(this),a.children.length-1},r.prototype.appendChild=function(a){return a.parent=this,this.children.push(a),this.children.length-1},r.prototype.insertNode=function(a){for(var b in this.children)this.children[b].parent=a;a.children=a.children.concat(this.children),a.parent=this,this.children=[a]},r.prototype.fromJgf=function(a,c){if("undefined"!=typeof a.tree)return r.fromJgf(a.tree,c);var d,e,f,g;for(c=c||this,f=0;f<a.length;f++){if(b.isArray(a[f]))for(g=0;g<a[f].length;g++)d=new r,d.fromJgf(a[f][g]),c.appendChild(d);else{var h=Object.getOwnPropertyNames(a[f]);for(var i in h){var j=h[i];c[j]="undefined"!=typeof q.fromJgf[j]?q.fromJgf[j](a[f][j]):"object"==typeof a[f][j]?b.copy(a[f][j]):a[f][j]}}f+1<a.length&&!b.isArray(a[f+1])&&(e=new r,c.appendChild(e),c=e)}},r.prototype.toJgf=function(a){a=a||[];var c={},d=Object.getOwnPropertyNames(this);for(var e in d){var f=d[e];"parent"!=f&&"children"!=f&&(c[f]="undefined"!=typeof q.toJgf[f]?q.toJgf[f](this[f]):"object"==typeof this[f]?b.copy(this[f]):this[f])}if(a.push(c),this.children.length>1){var g=[];a.push(g);for(var h in this.children){var i=[];g.push(i),this.children[h].toJgf(i)}}else 1==this.children.length&&this.children[0].toJgf(a);return a},r}]),b.module("ngGo.Game.Position.Service",["ngGo","ngGo.Board.Grid.Service"]).factory("GamePosition",["StoneColor","BoardGrid",function(a,b){var c=function(c,d){this.error=0,this.width=0,this.height=0,this.stones=new b,this.markup=new b,this.turn=a.B,this.captures={},this.captures[a.B]=[],this.captures[a.W]=[],this.stones.whenEmpty(a.NONE),(c||d)&&this.setSize(c,d)};return c.prototype.setSize=function(a,b){a=a||b||0,b=b||a||0,this.width=parseInt(a),this.height=parseInt(b),this.stones.setSize(a,b),this.markup.setSize(a,b),this.clear()},c.prototype.clear=function(){this.stones.clear(),this.markup.clear()},c.prototype.setStone=function(a,b,c){this.stones.set(a,b,c)},c.prototype.setMarkup=function(a,b,c){this.markup.set(a,b,c)},c.prototype.hasLiberties=function(c,d,e,f){if(!this.stones.isOnGrid(c,d))return!1;f=f||new b(this.width,this.height);var g=this.stones.get(c,d);return e=e||g,f.get(c,d)===!0||g===-e?!1:g===a.NONE?!0:(f.set(c,d,!0),this.hasLiberties(c,d-1,e,f)||this.hasLiberties(c,d+1,e,f)||this.hasLiberties(c-1,d,e,f)||this.hasLiberties(c+1,d,e,f))},c.prototype.captureAdjacent=function(a,b,c){if(!this.stones.isOnGrid(a,b))return!1;c=c||this.stones.get(a,b);var d=!1;return this.canCapture(a,b-1,-c,!0)&&(d=!0),this.canCapture(a,b+1,-c,!0)&&(d=!0),this.canCapture(a-1,b,-c,!0)&&(d=!0),this.canCapture(a+1,b,-c,!0)&&(d=!0),d},c.prototype.canCapture=function(a,b,c,d){return this.stones.isOnGrid(a,b)?(c=c||this.stones.get(a,b),this.stones.get(a,b)!==c?!1:this.hasLiberties(a,b,c)?!1:(d&&this.captureGroup(a,b,c),!0)):!1},c.prototype.captureGroup=function(a,b,c){return this.stones.isOnGrid(a,b)?(c=c||this.stones.get(a,b),this.stones.get(a,b)!==c?!1:(this.captureStone(a,b),this.captureGroup(a,b-1,c),this.captureGroup(a,b+1,c),this.captureGroup(a-1,b,c),this.captureGroup(a+1,b,c),!0)):!1},c.prototype.captureStone=function(b,c){if(this.stones.isOnGrid(b,c)){var d=this.stones.get(b,c);d!==a.NONE&&(this.stones.set(b,c,a.NONE),this.captures[d].push({x:b,y:c}))}},c.prototype.setCaptures=function(a,b){this.captures[a]=b},c.prototype.getCaptures=function(a){return this.captures[a]||[]},c.prototype.getCaptureCount=function(a){return this.captures[-a].length},c.prototype.setTurn=function(a){this.turn=a},c.prototype.getTurn=function(){return this.turn},c.prototype.switchTurn=function(){this.turn=-this.turn},c.prototype.clone=function(){var a=new c;return a.turn=this.turn,a.width=this.width,a.height=this.height,a.stones=this.stones.clone(),a.markup=new b(this.width,this.height),a},c.prototype.isSameAs=function(a){return this.width!=a.width||this.height!=a.height?!1:this.stones.isSameAs(a.stones)},c}]),b.module("ngGo.Game.Scorer.Service",["ngGo","ngGo.Board.Grid.Service"]).factory("GameScorer",["StoneColor","BoardGrid",function(a,b){var c={UNKNOWN:a.NONE,BLACK_STONE:a.B,WHITE_STONE:a.W,BLACK_CANDIDATE:2*a.B,WHITE_CANDIDATE:2*a.W,NEUTRAL:3*a.B},d=function(a,b,c,e){var f=this.stones.get(a,b),g=this.game.position.stones.get(a,b);this.stones.isOnGrid(a,b)&&f!=c&&f!=e&&(2*g==c?this.stones.set(a,b,g):this.stones.set(a,b,c),d.call(this,a-1,b,c,e),d.call(this,a,b-1,c,e),d.call(this,a+1,b,c,e),d.call(this,a,b+1,c,e))},e=function(a,b){var c=this.game.position.stones.get(a,b);this.stones.isOnGrid(a,b)&&this.stones.get(a,b)!=c&&(this.stones.set(a,b,c),e.call(this,a-1,b),e.call(this,a,b-1),e.call(this,a+1,b),e.call(this,a,b+1))},f=function(){for(var a,b,d,e,f,g,h,i,j=!0;j;)for(j=!1,h=0;h<this.stones.width;h++)for(i=0;i<this.stones.height;i++)if(a=this.stones.get(h,i),a==c.UNKNOWN||a==c.BLACK_CANDIDATE||a==c.WHITE_CANDIDATE){for(d=[this.stones.get(h-1,i),this.stones.get(h,i-1),this.stones.get(h+1,i),this.stones.get(h,i+1)],e=f=!1,g=0;4>g;g++)d[g]==c.BLACK_STONE||d[g]==c.BLACK_CANDIDATE?e=!0:d[g]==c.WHITE_STONE||d[g]==c.WHITE_CANDIDATE?f=!0:d[g]==c.NEUTRAL&&(e=f=!0);b=e&&f?c.NEUTRAL:e?c.BLACK_CANDIDATE:f?c.WHITE_CANDIDATE:!1,b!==!1&&b!=a&&(j=!0,this.stones.set(h,i,b))}},g={game:null,score:null,stones:null,captures:null,points:null,load:function(a){this.game=a,this.stones=this.game.position.stones.clone(),this.captures=new b(this.stones.width,this.stones.height,this.stones.emptyValue),this.points=new b(this.stones.width,this.stones.height,this.stones.emptyValue)},getScore:function(){return this.score},getPoints:function(){return this.points},getCaptures:function(){return this.captures},calculate:function(){if(!this.game)return void console.warn("No game loaded in game scorer, can't calutlate score.");this.points.clear(),this.captures.clear(),f.call(this);var b=this.game.get("game.komi"),d=this.game.getCaptureCount();this.score={black:{stones:0,territory:0,captures:d[a.B],komi:0>b?b:0},white:{stones:0,territory:0,captures:d[a.W],komi:b>0?b:0}};var e,g,h,i;for(e=0;e<this.stones.width;e++)for(g=0;g<this.stones.height;g++)h=this.stones.get(e,g),i=this.game.position.stones.get(e,g),h!=c.BLACK_STONE||i!=a.B?h!=c.WHITE_STONE||i!=a.W?h!=c.BLACK_CANDIDATE?h!=c.WHITE_CANDIDATE||(this.score.white.territory++,this.points.set(e,g,a.W),i==a.B&&(this.score.white.captures++,this.captures.set(e,g,a.B))):(this.score.black.territory++,this.points.set(e,g,a.B),i==a.W&&(this.score.black.captures++,this.captures.set(e,g,a.W))):this.score.white.stones++:this.score.black.stones++},mark:function(b,f){var g=this.game.position.stones.get(b,f),h=this.stones.get(b,f);g==a.W?h==c.WHITE_STONE?d.call(this,b,f,c.BLACK_CANDIDATE,c.BLACK_STONE):e.call(this,b,f):g==a.B&&(h==c.BLACK_STONE?d.call(this,b,f,c.WHITE_CANDIDATE,c.WHITE_STONE):e.call(this,b,f))}};return g}]),b.module("ngGo.Kifu.Blank.Service",["ngGo"]).factory("KifuBlank",["ngGo",function(a){var c={record:{application:a.name+" v"+a.version,version:1,charset:"UTF-8"},game:{type:"go",players:[{color:"black",name:"Black"},{color:"white",name:"White"}]},board:{width:19,height:19},tree:[]},d={AP:a.name+":"+a.version,CA:"UTF-8",FF:"4",GM:"1",SZ:"19",PB:"Black",PW:"White"},e={jgf:function(a){var d=b.copy(c);if(a)for(var e in a)d[e]=b.extend(d[e]||{},a[e]);return d},sgf:function(a){var c=b.copy(d);if(a)for(var e in a)c[e]=b.extend(c[e]||{},a[e]);return c}};return e}]),b.module("ngGo.Kifu.Parser.Service",["ngGo","ngGo.Kifu.Parsers.Sgf2Jgf.Service","ngGo.Kifu.Parsers.Jgf2Sgf.Service"]).factory("KifuParser",["Sgf2Jgf","Jgf2Sgf",function(a,b){var c={sgf2jgf:function(b,c){return a.parse(b,c)},jgf2sgf:function(a){return b.parse(a)}};return c}]).constant("sgfAliases",{AP:"record.application",CA:"record.charset",CP:"record.copyright",SO:"record.source",US:"record.transcriber",AN:"record.annotator",GM:"game.type",GN:"game.name",KM:"game.komi",HA:"game.handicap",RE:"game.result",RU:"game.rules",TM:"game.time.main",OT:"game.time.overtime",DT:"game.dates",PC:"game.location",EV:"game.event",RO:"game.round",ON:"game.opening",GC:"game.comment",PB:"name",PW:"name",BT:"team",WT:"team",BR:"rank",WR:"rank",N:"name",C:"comments",CR:"circle",TR:"triangle",SQ:"square",MA:"mark",SL:"select",LB:"label"}).constant("sgfGames",{1:"go",2:"othello",3:"chess",4:"renju",6:"backgammon",7:"chinese chess",8:"shogi"}),b.module("ngGo.Kifu.Parsers.Jgf2Sgf.Service",["ngGo","ngGo.Kifu.Blank.Service"]).factory("Jgf2Sgf",["ngGo","sgfAliases","sgfGames","KifuBlank",function(a,c,d,e){var f={};for(var g in c)f[c[g]]=g;var h=function(a){return"string"==typeof a?a.replace(/\\/g,"\\\\").replace(/]/g,"\\]"):a},i=function(a,b,c,d){if(b.length){c.sgf+=a;for(var e in b)c.sgf+="["+(d?h(b[e]):b[e])+"]"}},j=function(a,b){var c=a.B?"B":a.W?"W":"";if(""!==c){var d="pass"==a[c]?"":a[c];b.sgf+=c+"["+d+"]"}},k=function(a,b){for(var c in a){var d=a[c];i("A"+c,d,b)}},l=function(a,b){for(var c in a){var d=a[c];i("T"+c,d,b)}},m=function(a,b){for(var c in a){var d=a[c];if("label"==c)for(var e=0;e<d.length;e++)d[e]=d[e][0]+":"+d[e][1];"undefined"!=typeof f[c]&&(c=f[c]),i(c,d,b)}},n=function(a,b){b.sgf+="PL["+a+"]"},o=function(a,b){var c="undefined"!=typeof f.comments?f.comments:"C";i(c,a,b,!0)},p=function(a,b){var c="undefined"!=typeof f.name?f.name:"N";b.sgf+=c+"["+h(a)+"]"},q=function(a){for(var b in d)if(d[b]==a)return b;return 0},r=function(a){var b=a.split(" v");return b.length>1?b[0]+":"+b[1]:a},s=function(a,b){var c=0;a.variation_markup||(c+=2),a.variation_siblings&&(c+=1),b.ST=c},t=function(a,b){b.SZ=a.width&&a.height?a.width==a.height?a.width:a.width+":"+a.height:a.width?a.width:a.height?a.height:""},u=function(a,b){for(var c=0;c<a.length;c++)if(a[c].color&&("black"==a[c].color||"white"==a[c].color)){var d="black"==a[c].color?"B":"W";a[c].name&&(b["P"+d]=a[c].name),a[c].rank&&(b[d+"R"]=a[c].rank),a[c].team&&(b[d+"T"]=a[c].team)}},v={move:j,setup:k,score:l,markup:m,turn:n,comments:o,name:p,"record.application":r,display:s,board:t,"game.type":q,"game.players":u},w=function(a,c){for(var d=0;d<a.length;d++){var e=a[d];if(b.isArray(e))for(var f=0;f<e.length;f++)c.sgf+="(\n;",w(e[f],c),c.sgf+="\n)";else{for(var g in e)"undefined"==typeof v[g]?"object"!=typeof props[g]&&(c.sgf+=g+"["+h(e[g])+"]"):v[g](e[g],c);d+1<a.length&&(c.sgf+="\n;")}}},x=function(a,b,c){"undefined"==typeof c&&(c="");for(var d in a)if("sgf"!=d){var e=""===c?d:c+"."+d;if("object"!=typeof a[d]){var g;"undefined"!=typeof f[e]&&(g="undefined"!=typeof v[e]?v[e](a[d]):h(a[d]),b[f[e]]=g)}else"undefined"!=typeof v[e]?v[e](a[d],b):x(a[d],b,e)}},y={parse:function(a){if("string"==typeof a&&(a=JSON.parse(a)),!a.tree)return void console.error("No moves tree in JGF object");var c={sgf:"(\n;"},d=b.copy(a),f=e.sgf();a.tree&&a.tree.length>0&&a.tree[0].root&&(d=b.extend(d,a.tree[0]),delete d.root,delete a.tree[0]),delete d.tree,x(d,f);for(var g in f)f[g]&&(c.sgf+=g+"["+h(f[g])+"]");return w(a.tree,c),c.sgf+=")",c.sgf}};return y}]),b.module("ngGo.Kifu.Parsers.Sgf2Jgf.Service",["ngGo","ngGo.Kifu.Blank.Service"]).factory("Sgf2Jgf",["ngGo","sgfAliases","sgfGames","KifuBlank",function(a,c,d,e){var f=/\(|\)|(;(\s*[A-Z]+\s*((\[\])|(\[(.|\s)*?([^\\]\])))+)*)/g,g=/[A-Z]+\s*((\[\])|(\[(.|\s)*?([^\\]\])))+/g,h=/[A-Z]+/,i=/(\[\])|(\[(.|\s)*?([^\\]\]))/g,j=function(a,b,c,d){if(!a.record.application){var e=d[0].split(":");a.record.application=e.length>1?e[0]+" v"+e[1]:e[0]}},k=function(){},l=function(a,b,c,e){var f=e[0];a.game.type="undefined"!=typeof d[f]?d[f]:e[0]},m=function(a,b,c,d){b.move={},b.move[c]=""===d[0]||a.width<=19&&"tt"==d[0].toLowerCase()?"pass":d[0].toLowerCase()},n=function(a,b,d,e){"undefined"!=typeof c[d]&&(d=c[d]),b[d]=e},o=function(a,b,d,e){"undefined"!=typeof c[d]&&(d=c[d]),b[d]=e[0]},p=function(a,b,c,d){"undefined"==typeof b.setup&&(b.setup={}),c=c.charAt(1),"undefined"==typeof b.setup[c]&&(b.setup[c]=[]);for(var e in d)b.setup[c].push(d[e].toLowerCase())},q=function(a,b,c,d){"undefined"==typeof b.score&&(b.score={B:[],W:[]}),c=c.charAt(1);for(var e in d)b.score[c].push(d[e].toLowerCase())},r=function(a,b,c,d){b.turn=d[0]},s=function(a,b,d,e){"undefined"!=typeof c[d]&&(d=c[d]),"undefined"==typeof b.markup&&(b.markup={}),"undefined"==typeof b.markup[d]&&(b.markup[d]=[]);for(var f in e){var g=e[f].substr(0,2).toLowerCase(),h=e[f].substr(3);b.markup[d].push([g,h])}},t=function(a,b,d,e){"undefined"!=typeof c[d]&&(d=c[d]),"undefined"==typeof b.markup&&(b.markup={}),"undefined"==typeof b.markup[d]&&(b.markup[d]=[]);for(var f in e)b.markup[d].push(e[f].toLowerCase())},u=function(a,b,c,d){"undefined"==typeof a.board&&(a.board={});var e=d[0].split(":");e.length>1?(a.board.width=parseInt(e[0]),a.board.height=parseInt(e[1])):a.board.width=a.board.height=parseInt(e[0])
},v=function(a,b,c,d){a.game.komi=parseFloat(d[0])},w=function(a,b,c,d){"undefined"==typeof a.display&&(a.display={}),a.display.variation_markup=!1,a.display.variation_children=!1,a.display.variation_siblings=!1;var e=parseInt(d[0]);switch(e){case 0:a.display.variation_markup=!0,a.display.variation_children=!0;break;case 1:a.display.variation_markup=!0,a.display.variation_siblings=!0;break;case 2:a.display.variation_children=!0;break;case 3:a.display.variation_siblings=!0}},x=function(a,b,d,e){"undefined"==typeof a.game.players&&(a.game.players=[]);var f="PB"==d||"BT"==d||"BR"==d?"black":"white";"undefined"!=typeof c[d]&&(d=c[d]);for(var g=0;g<a.game.players.length;g++)if(a.game.players[g].color==f)return void(a.game.players[g][d]=e[0]);var h={color:f};h[d]=e[0],a.game.players.push(h)},y={AP:j,FF:k,GM:l,SZ:u,KM:v,ST:w,PB:x,PW:x,BT:x,WT:x,BR:x,WR:x,B:m,W:m,C:n,N:o,AB:p,AW:p,AE:p,PL:r,TW:q,TB:q,CR:t,SQ:t,TR:t,MA:t,SL:t,LB:s},z=["B","W","C","N","AB","AW","AE","PL","LB","CR","SQ","TR","MA","SL","TW","TB"],A=function(a,b,c){if("object"==typeof b){for(var d,e=a,f=0;f<b.length&&(d=b[f],f+1!=b.length);f++)"object"!=typeof e[d]&&(e[d]={}),e=e[d];e[d]=c}},B={parse:function(a){var d=e.jgf({record:{sgf:{}}}),j=[],k=d.tree,l={root:!0};k.push(l);var m=a.match(f);for(var n in m)if("("!=m[n])if(")"!=m[n]){var o=m[n].match(g)||[];for(var p in o){var q=h.exec(o[p])[0].toUpperCase(),r=o[p].match(i);for(var s in r)r[s]=r[s].substring(1,r[s].length-1).replace(/\\(?!\\)/g,"");"undefined"==typeof y[q]?(1==r.length&&(r=r[0]),"undefined"==typeof c[q]?l?l[q]=r:d[q]=r:A(d,c[q].split("."),r)):(-1!==z.indexOf(q)&&(l&&"B"!=q&&"W"!=q||(l={},k.push(l))),y[q](d,l,q,r))}l&&!l.root&&(l=null)}else j.length&&(k=j.pop());else{if(0===n||"0"===n)continue;j.push(k),b.isArray(k[k.length-1])||k.push([]),k=k[k.length-1],k.push([]),k=k[k.length-1]}return d}};return B}]),b.module("ngGo",[]).constant("ngGo",{name:"ngGo",version:"3.0.2",error:{MOVE_OUT_OF_BOUNDS:1,MOVE_ALREADY_HAS_STONE:2,MOVE_IS_SUICIDE:3,MOVE_IS_REPEATING:4}}).constant("StoneColor",{E:0,NONE:0,B:1,BLACK:1,W:-1,WHITE:-1}),b.module("ngGo.Templates",[]),b.module("ngGo.Player.Directive",["ngGo.Board.Service","ngGo.Board.Directive"]).directive("player",["$window","$document","Player","Board",function(a,c,d){return{restrict:"E",controller:["$scope",function(a){a.Player=d}],link:function(e,f,g){var h=f.parent(),i=Math.min(h[0].clientWidth,h[0].clientHeight);i>0&&(f.css({width:i,height:i}),e.$broadcast("ngGo.board.resize",i,i)),e.$watch("Board",function(a){d.board=a}),e.$on("ngGo.player.resize",function(){i=Math.min(h[0].clientWidth,h[0].clientHeight),f.css({width:i,height:i}),e.$broadcast("ngGo.board.resize",i,i)}),b.element(a).on("resize.ngGo.player",function(){e.$broadcast("ngGo.player.resize")});for(var j=d.getElementEvents(),k=0;k<j.length;k++)"keydown"==j[k]?c.on("keydown.ngGo.player",d.broadcast.bind(d,j[k])):f.on(j[k]+".ngGo.player",d.broadcast.bind(d,j[k]));g.$observe("mode",function(a){d.switchMode(a)}),g.$observe("tool",function(a){d.switchTool(a)}),g.$observe("variationMarkup",function(a){d.toggleVariationMarkup(parseBool(a))}),g.$observe("solutionPaths",function(a){d.toggleSolutionPaths(parseBool(a))}),g.$observe("arrowKeysNavigation",function(a){d.toggleArrowKeysNavigation(parseBool(a))}),g.$observe("scrollWheelNavigation",function(a){d.toggleScrollWheelNavigation(parseBool(a))}),g.$observe("markLastMove",function(a){d.toggleMarkLastMove(parseBool(a))}),g.$observe("lastMoveMarker",function(a){d.setLastMoveMarker(a)})}}}]),b.module("ngGo.Player.Service",["ngGo","ngGo.Player.Directive","ngGo.Player.Mode.Common.Service","ngGo.Board.Service","ngGo.Game.Service","ngGo.Game.Scorer.Service"]).constant("PlayerModes",{PLAY:"play",REPLAY:"replay",EDIT:"edit",SOLVE:"solve"}).constant("PlayerTools",{NONE:"none",MOVE:"move",SCORE:"score",SETUP:"setup",MARKUP:"markup"}).constant("MarkupTypes",{TRIANGLE:"triangle",CIRCLE:"circle",SQUARE:"square",MARK:"mark",SELECT:"select",LABEL:"label",LAST:"last",SAD:"sad",HAPPY:"happy"}).provider("Player",["PlayerModes",function(){var c={arrowKeysNavigation:!0,scrollWheelNavigation:!0,lockScroll:!0,markLastMove:!0,lastMoveMarker:"last",allowDisplayInstructions:!0,variationMarkup:!0,variationChildren:!0,variationSiblings:!1,solutionPaths:!1,solveAutoPlay:!0,solveAutoPlayTimeout:500,elementEvents:["keydown","click","mousedown","mouseup","mousemove","mouseout","mousewheel"]};this.setConfig=function(a){c=b.extend(c,a)},this.$get=["$rootScope","Game","GameScorer","Board","PlayerModes","PlayerTools",function(d,e,f,g,h,i){var j=function(b,c){if(!this.board)return b.x=-1,void(b.y=-1);var d=c.offsetX||c.originalEvent.offsetX||c.originalEvent.layerX,e=c.offsetY||c.originalEvent.offsetY||c.originalEvent.layerY;d*=a.devicePixelRatio||1,e*=a.devicePixelRatio||1,b.x=this.board.getGridX(d),b.y=this.board.getGridY(e),c.drag&&(b.drag=c.drag)},k={config:b.copy(c),board:null,game:new e,path:null,frozen:!1,mode:null,tool:null,modes:{},tools:[],load:function(a,b){if(!this.game.load(a))return!1;this.config.allowDisplayInstructions&&this.displayInstructions(this.game.get("display"));var c=this.game.get("board");this.board.removeAll(),this.board.setSize(c.width,c.height),this.board.setSection(c.section),b?this.goto(b):this.first(),this.broadcast("gameLoaded",this.game)},displayInstructions:function(a){a&&("undefined"!=typeof a.variation_markup&&(this.variationMarkup=a.variation_markup),"undefined"!=typeof a.variation_children&&(this.variationChildren=a.variation_children),"undefined"!=typeof a.variation_siblings&&(this.variationSiblings=a.variation_siblings),"undefined"!=typeof a.solution_paths&&(this.solutionPaths=a.solution_paths))},next:function(a){!this.frozen&&this.game&&(this.game.next(a),this.updateBoard())},previous:function(){!this.frozen&&this.game&&(this.game.previous(),this.updateBoard())},last:function(){!this.frozen&&this.game&&(this.game.last(),this.updateBoard())},first:function(){!this.frozen&&this.game&&(this.game.first(),this.updateBoard())},"goto":function(a){!this.frozen&&this.game&&(this.game.goto(a),this.updateBoard())},updateBoard:function(){var a=!1,c=this.game.getNode(),d=this.game.getPath(),e=this.game.getPosition();b.equals(this.path,d)||(a=!0,this.path=b.copy(d),this.board.removeAll("markup"),c.mode&&this.switchMode(c.mode)),this.board.setAll("stones",e.stones),this.board.setAll("markup",e.markup),c.move&&(c.move.pass?this.broadcast("notification","pass"):this.config.markLastMove&&this.board.add("markup",c.move.x,c.move.y,this.config.lastMoveMarker)),this.broadcast("update",a)},freeze:function(){this.frozen=!0,this.broadcast("freeze")},unFreeze:function(){this.frozen=!1,this.broadcast("unfreeze")},switchMode:function(a){return a=a||this.mode,this.mode!=a&&this.modes[a]?(this.broadcast("modeExit",this.mode),this.mode=a,this.tools=[],this.tool=i.NONE,this.broadcast("modeEnter",this.mode),!0):!1},switchTool:function(a){return a=a||i.NONE,this.tool==a||-1===this.tools.indexOf(a)?!1:(this.tool=a,void this.broadcast("toolSwitch",this.tool))},scoreGame:function(){f.calculate();var a=f.getScore(),b=f.getPoints(),c=f.getCaptures();this.board.layers.markup.removeAll(),this.board.layers.score.setAll(b,c),this.broadcast("score",a)},toggleSolutionPaths:function(a){this.config.solutionPaths="undefined"!=typeof a?a:!this.config.solutionPaths,this.broadcast("config","solutionPaths")},toggleVariationMarkup:function(a){this.config.variationMarkup="undefined"!=typeof a?a:!this.config.variationMarkup,this.broadcast("config","variationMarkup")},toggleArrowKeysNavigation:function(a){this.config.arrowKeysNavigation="undefined"!=typeof a?a:!this.config.arrowKeysNavigation,this.broadcast("config","arrowKeysNavigation")},toggleScrollWheelNavigation:function(a){this.config.scrollWheelNavigation="undefined"!=typeof a?a:!this.config.scrollWheelNavigation,this.broadcast("config","scrollWheelNavigation")},toggleMarkLastMove:function(a){this.config.markLastMove="undefined"!=typeof a?a:!this.config.markLastMove,this.broadcast("config","markLastMove")},setLastMoveMarker:function(a){this.config.lastMoveMarker=a,this.broadcast("config","lastMoveMarker")},getElementEvents:function(){return this.config.elementEvents},on:function(a,b,c){var e=this;d.$on("ngGo.player."+a,function(){if(!c||("string"!=typeof c||c==e.mode)&&-1!==c.indexOf(e.mode)){if(("click"==a||"hover"==a||"mouse"==a.substr(0,5))&&j.call(e,arguments[0],arguments[1]),e.preventClickEvent&&"click"==a)return void delete e.preventClickEvent;"mousedrag"==a&&(e.preventClickEvent=!0),b.apply(e,arguments)}})},broadcast:function(a,b){d.$$phase?d.$broadcast("ngGo.player."+a,b):d.$apply(function(){d.$broadcast("ngGo.player."+a,b)})}};return k}]}]),b.module("ngGo.Player.Mode.Common.Service",["ngGo","ngGo.Game.Scorer.Service"]).run(["Player","PlayerModes","PlayerModeCommon",function(a,b,c){a.on("keydown",c.keyDown,[b.REPLAY,b.EDIT]),a.on("mousewheel",c.mouseWheel,[b.REPLAY,b.EDIT]),a.on("mousemove",c.mouseMove,[b.REPLAY,b.EDIT,b.SOLVE]),a.on("mouseout",c.mouseOut,[b.REPLAY,b.EDIT,b.SOLVE]),a.on("mousedown",c.mouseDown,[b.REPLAY,b.EDIT,b.SOLVE]),a.on("mouseup",c.mouseUp,[b.REPLAY,b.EDIT,b.SOLVE]),a.on("toolSwitch",c.toolSwitch,[b.REPLAY,b.EDIT])}]).factory("PlayerModeCommon",["$document","PlayerTools","GameScorer",function(a,b,c){var d,e,f=null,g=function(a){var b={start:{x:f.x>a.x?a.x:f.x,y:f.y>a.y?a.y:f.y},stop:{x:f.x>a.x?f.x:a.x,y:f.y>a.y?f.y:a.y}};return b.start.x<0&&(b.start.x=0),b.start.y<0&&(b.start.y=0),b.stop.x>this.board.width-1&&(b.stop.x=this.board.width-1),b.stop.y>this.board.height-1&&(b.stop.y=this.board.height-1),b},h={keyDown:function(c,d){if(a[0].querySelector(":focus"))return!0;switch(this.board.removeAll("hover"),d.keyCode){case 27:f=null,this.preventClickEvent=!0;break;case 39:this.config.arrowKeysNavigation&&this.tool==b.MOVE&&this.next();break;case 37:this.config.arrowKeysNavigation&&this.tool==b.MOVE&&this.previous();break;default:return!0}this.config.lockScroll&&d.preventDefault()},mouseWheel:function(a,c){if(!this.config.scrollWheelNavigation||this.tool!=b.MOVE)return!0;var d=c.deltaY||c.originalEvent.deltaY;0>d?(this.board.layers.hover.remove(),this.next()):d>0&&(this.board.layers.hover.remove(),this.previous()),0!==d&&this.config.lockScroll&&c.preventDefault()},mouseOut:function(){this.board.layers.hover.remove()},mouseMove:function(a,b){!f||f.x==a.x&&f.y==a.y||(b.drag=g.call(this,a)),!this.frozen&&this.board.layers.hover&&(d!=a.x||e!=a.y)&&(d=a.x,e=a.y,this.broadcast("hover",b))},mouseDown:function(a){f={x:a.x,y:a.y}},mouseUp:function(a,b){!f||f.x==a.x&&f.y==a.y||(b.drag=g.call(this,a),this.broadcast("mousedrag",b)),f=null},toolSwitch:function(){this.tool==b.SCORE?(this.statePreScoring=this.board.getState(),c.load(this.game),this.scoreGame()):this.statePreScoring&&(this.board.restoreState(this.statePreScoring),delete this.statePreScoring)}};return h}]),b.module("ngGo.Player.Mode.Edit.Service",["ngGo","ngGo.Game.Scorer.Service"]).run(["Player","PlayerModes","PlayerModeEdit","StoneColor",function(a,b,c,d){a.modes[b.EDIT]=c,a.on("modeEnter",c.modeEnter,b.EDIT),a.on("keydown",c.keyDown,b.EDIT),a.on("click",c.click,b.EDIT),a.on("mousedrag",c.mouseDrag,b.EDIT),a.on("hover",c.hover,b.EDIT),a.setupTools={BLACK:"black",WHITE:"white",CLEAR:"clear"},a.markupTools={TRIANGLE:"triangle",CIRCLE:"circle",SQUARE:"square",MARK:"mark",SELECT:"select",SAD:"sad",HAPPY:"happy",TEXT:"text",NUMBER:"number",CLEAR:"clear"},a.setupTool=a.setupTools.BLACK,a.markupTool=a.markupTools.TRIANGLE,a.markupTextLabel="A",a.markupNumberLabel="1",a.switchSetupTool=function(a){this.setupTool=a},a.switchMarkupTool=function(a){this.markupTool=a},a.setupToolColor=function(){switch(this.setupTool){case this.setupTools.BLACK:return d.B;case this.setupTools.WHITE:return d.W;default:return d.NONE}},a.setMarkupTextLabel=function(a){a&&(this.markupTextLabel=a)},a.setMarkupNumberLabel=function(a){(a=parseInt(a))&&(this.markupNumberLabel=a)},a.incrementMarkupTextLabel=function(){if("Z"==this.markupTextLabel)return void(this.markupTextLabel="a");var a=this.markupTextLabel.charCodeAt(0);this.markupTextLabel=String.fromCharCode(++a)},a.incrementMarkupNumberLabel=function(){this.markupNumberLabel++}}]).factory("PlayerModeEdit",["$document","PlayerTools","MarkupTypes","GameScorer","StoneColor",function(a,b,c,d,e){var f=function(a,d,e){if(this.board.isOnBoard(a,d))switch(this.tool){case b.SETUP:this.setupTool==this.setupTools.CLEAR?this.game.hasStone(a,d)&&this.board.add("hover",a,d,{type:"markup",value:c.MARK}):this.game.hasStone(a,d,this.setupToolColor())?e||this.board.add("hover",a,d,{type:"markup",value:c.MARK}):this.board.add("hover",a,d,{type:"stones",value:this.setupToolColor()});break;case b.MARKUP:this.markupTool==this.markupTools.CLEAR?this.game.hasMarkup(a,d)&&this.board.add("hover",a,d,{type:"markup",value:c.MARK}):this.markupTool==this.markupTools.TEXT?this.board.add("hover",a,d,{type:"markup",value:{type:c.LABEL,text:this.markupTextLabel}}):this.markupTool==this.markupTools.NUMBER?this.board.add("hover",a,d,{type:"markup",value:{type:c.LABEL,text:this.markupNumberLabel}}):this.board.add("hover",a,d,{type:"markup",value:this.markupTool});break;case b.MOVE:!this.game.hasStone(a,d)&&this.game.isValidMove(a,d)&&this.board.add("hover",a,d,{type:"stones",value:this.game.getTurn()});break;case b.SCORE:this.game.hasStone(a,d)&&this.board.add("hover",a,d,{type:"markup",value:c.MARK})}},g=function(a,b){this.game.hasMarkup(a,b)&&this.game.removeMarkup(a,b),this.markupTool!=this.markupTools.CLEAR&&(this.markupTool==this.markupTools.TEXT?(this.game.addMarkup(a,b,{type:c.LABEL,text:this.markupTextLabel}),this.incrementMarkupTextLabel()):this.markupTool==this.markupTools.NUMBER?(this.game.addMarkup(a,b,{type:c.LABEL,text:this.markupNumberLabel}),this.incrementMarkupNumberLabel()):this.game.addMarkup(a,b,this.markupTool))},h=function(a,b,c){var d=this.setupToolColor();if(d===e.NONE)this.game.removeStone(a,b);else{if(!c&&this.game.hasStone(a,b,d))return void this.game.removeStone(a,b);this.game.hasStone(a,b)&&this.game.removeStone(a,b),this.game.addStone(a,b,d)}this.board.layers.markup.redrawCell(a,b)},i={hover:function(a){if(this.board.removeAll("hover"),!a.drag||this.tool!=b.SETUP&&this.tool!=b.MARKUP)return void f.call(this,a.x,a.y,!1);for(x=a.drag.start.x;x<=a.drag.stop.x;x++)for(y=a.drag.start.y;y<=a.drag.stop.y;y++)f.call(this,x,y,!0)},keyDown:function(b,c){if(a[0].querySelector(":focus"))return!0;switch(c.keyCode){default:return!0}},click:function(a){if(this.board.isOnBoard(a.x,a.y)){switch(this.board.removeAll("hover"),this.tool){case b.MOVE:if(!this.game.play(a.x,a.y))return;this.updateBoard();break;case b.SETUP:h.call(this,a.x,a.y),this.updateBoard();break;case b.MARKUP:g.call(this,a.x,a.y),this.updateBoard();break;case b.SCORE:d.mark(a.x,a.y),this.scoreGame()}i.hover.call(this,a)}},mouseDrag:function(a){var c,d;switch(this.board.removeAll("hover"),this.tool){case b.SETUP:for(c=a.drag.start.x;c<=a.drag.stop.x;c++)for(d=a.drag.start.y;d<=a.drag.stop.y;d++)h.call(this,c,d,!0);this.updateBoard();break;case b.MARKUP:for(c=a.drag.start.x;c<=a.drag.stop.x;c++)for(d=a.drag.start.y;d<=a.drag.stop.y;d++)g.call(this,c,d);this.updateBoard()}i.hover.call(this,a)},modeEnter:function(){this.tools=[b.MOVE,b.SETUP,b.MARKUP,b.SCORE],this.tool=this.tools[0]}};return i}]),b.module("ngGo.Player.Mode.Replay.Service",["ngGo","ngGo.Game.Scorer.Service"]).run(["Player","PlayerModes","PlayerModeReplay",function(a,b,c){a.modes[b.REPLAY]=c,a.on("modeEnter",c.modeEnter,b.REPLAY),a.on("modeExit",c.modeExit,b.REPLAY),a.on("update",c.update,b.REPLAY),a.on("config",c.config,b.REPLAY),a.on("click",c.click,b.REPLAY),a.on("hover",c.hover,b.REPLAY)}]).factory("PlayerModeReplay",["Player","PlayerTools","MarkupTypes","GameScorer",function(a,b,c,d){var e=function(a,d){if(this.board.isOnBoard(a,d))switch(this.tool){case b.MOVE:!this.game.hasStone(a,d)&&this.game.isValidMove(a,d)&&this.board.add("hover",a,d,{type:"stones",value:this.game.getTurn()});break;case b.SCORE:this.game.hasStone(a,d)&&this.board.add("hover",a,d,{type:"markup",value:c.MARK})}},f=function(a){for(var b=0;b<a.length;b++)this.board.has("markup",a[b].move.x,a[b].move.y)||this.board.add("markup",a[b].move.x,a[b].move.y,{type:c.LABEL,text:String.fromCharCode(65+b),color:this.board.theme.get("markupVariationColor")})},g=function(a){for(var b=0;b<a.length;b++)this.board.remove("markup",a[b].move.x,a[b].move.y)},h=function(a){var b,c=this.game.getNode();c&&(this.config.variationChildren&&c.hasMoveVariations()&&(b=c.getMoveVariations(),a?f.call(this,b):g.call(this,b)),this.config.variationSiblings&&c.parent&&c.parent.hasMoveVariations()&&(b=c.parent.getMoveVariations(),a?f.call(this,b):g.call(this,b)))},i={config:function(a,b){"variationMarkup"==b&&h.call(this,this.config.variationMarkup)},hover:function(a){this.board.removeAll("hover"),e.call(this,a.x,a.y)},update:function(){this.config.variationMarkup&&h.call(this,!0)},click:function(a){if(this.board.isOnBoard(a.x,a.y)){switch(this.tool){case b.MOVE:var c=this.game.isMoveVariation(a.x,a.y);-1!=c&&this.next(c);break;case b.SCORE:d.mark(a.x,a.y),this.scoreGame()}i.hover.call(this,a)}},modeEnter:function(){this.tools=[b.MOVE,b.SCORE],this.tool=this.tools[0],this.config.variationMarkup&&h.call(this,!0)},modeExit:function(){this.config.variationMarkup&&h.call(this,!1)}};return i}]),b.module("ngGo.Player.Mode.Solve.Service",["ngGo"]).run(["Player","PlayerModes","PlayerModeSolve",function(a,b,c){a.modes[b.SOLVE]=c,a.on("gameLoaded",c.gameLoaded,b.SOLVE),a.on("modeEnter",c.modeEnter,b.SOLVE),a.on("modeExit",c.modeExit,b.SOLVE),a.on("keydown",c.keyDown,b.SOLVE),a.on("update",c.update,b.SOLVE),a.on("config",c.config,b.SOLVE),a.on("click",c.click,b.SOLVE),a.on("hover",c.hover,b.SOLVE),a.problemPlayerColor=0,a.problemSolved=!1,a.problemOffPath=!1}]).factory("PlayerModeSolve",["$document","$timeout","Player","PlayerTools",function(a,b,c,d){var e=!1,f=function(){return this.config.solveAutoPlay?this.problemSolved?!0:this.problemOffPath?!0:this.game.getTurn()==this.problemPlayerColor?!0:!1:!0},g=function(a,b){if(this.board.isOnBoard(a,b))switch(this.tool){case d.MOVE:f.call(this)&&this.game.isValidMove(a,b)&&this.board.add("hover",a,b,{type:"stones",value:this.game.getTurn()})}},h=function(a){for(var b=0;b<a.length;b++)a[b].move.solution===!0?this.board.add("markup",a[b].move.x,a[b].move.y,{type:this.board.theme.get("problemSolutionMarkup"),scale:this.board.theme.get("problemSolutionScale"),color:this.board.theme.get("problemSolutionColor")}):this.board.add("markup",a[b].move.x,a[b].move.y,{type:this.board.theme.get("problemInvalidMarkup"),scale:this.board.theme.get("problemInvalidScale"),color:this.board.theme.get("problemInvalidColor")})},i=function(a){for(var b=0;b<a.length;b++)this.board.remove("markup",a[b].move.x,a[b].move.y)},j=function(a){var b=this.game.getNode(),c=b.getMoveVariations();a&&!this.problemSolved&&this.config.solveAutoPlay&&this.game.getTurn()!=this.problemPlayerColor||(a?h.call(this,c):i.call(this,c))},k={config:function(a,b){"solutionPaths"==b&&j.call(this,this.config.solutionPaths)},hover:function(a){this.board.removeAll("hover"),g.call(this,a.x,a.y)},update:function(){this.config.solutionPaths&&j.call(this,!0)},keyDown:function(b,c){if(a[0].querySelector(":focus"))return!0;switch(this.board.removeAll("hover"),c.keyCode){case 39:this.config.arrowKeysNavigation&&this.problemSolved&&this.next();break;case 37:this.config.arrowKeysNavigation&&!e&&(this.previous(),!this.problemSolved&&this.config.solveAutoPlay&&this.game.getTurn()==-this.problemPlayerColor&&this.previous());break;default:return!0}this.config.lockScroll&&c.preventDefault()},click:function(a){if(this.board.isOnBoard(a.x,a.y)){var c=this.game.isMoveVariation(a.x,a.y);if(-1!=c){this.next(c);var d=this.game.getNode();if(0===d.children.length)return void(d.move.solution?(this.problemSolved=!0,this.broadcast("solutionFound",d)):this.broadcast("solutionWrong",d));if(this.problemSolved||!this.config.solveAutoPlay)return;return c=Math.floor(Math.random()*d.children.length),self=this,this.config.solveAutoPlayTimeout?(e=!0,void b(function(){self.next(c),e=!1},this.config.solveAutoPlayTimeout)):void this.next(c)}this.game.play(a.x,a.y)&&(this.problemOffPath=!0,this.updateBoard(),this.broadcast("solutionWrong",this.game.getNode())),k.hover.call(this,a)}},gameLoaded:function(){this.problemPlayerColor=this.game.getTurn()},modeEnter:function(){this.tools=[d.MOVE],this.tool=this.tools[0],this.problemPlayerColor=this.game.getTurn(),this.config.solutionPaths&&j.call(this,!0)},modeExit:function(){this.config.solutionPaths&&j.call(this,!1)}};return k}])}(window,window.angular);